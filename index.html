<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Students Manager - Modern Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        /* --- 1. UI/UX DESIGN & THEME VARIABLES --- */
        :root {
            /* Theme Base */
            --color-primary: #3b82f6; /* Lighter Blue */
            --color-success: #10b981; /* Green */
            --color-warning: #f59e0b; /* Amber */
            --color-danger: #ef4444; /* Red */
            --color-star: #fbbf24; /* Yellow Star */
            --color-badge: #8b5cf6; /* Violet */

            /* Backgrounds */
            --bg-light: #f9fafb; /* Very light gray */
            --bg-medium: #ffffff; 
            --bg-dark: #e5e7eb; /* Subtle input background */
            --bg-accent: #f3f4f6; /* Light accent for lists */
            
            /* Text */
            --text-dark: #111827; /* Darker text */
            --text-muted: #6b7280; /* Gray text */
            
            /* Dimensions */
            --border-radius-card: 12px;
            --border-radius-input: 8px;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.08); /* Modern, softer shadow */
            --transition-duration: 0.3s;
            --sidebar-width: 240px; /* Slightly narrower */
            
            /* Avatar Colors (For male/female character distinction) */
            --avatar-color-male: #34d399; /* Emerald */
            --avatar-color-female: #fb7185; /* Rose */
        }

        /* --- DARK MODE OVERRIDES --- */
        body[data-theme="dark"] {
            --bg-light: #1f2937; 
            --bg-medium: #374151; 
            --bg-dark: #4b5563; 
            --bg-accent: #4b5563;
            --text-dark: #f9fafb;
            --text-muted: #d1d5db;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.4);
            --color-star: #fcd34d;
        }

        /* --- 2. BASE STYLES & LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark); 
            transition: all var(--transition-duration); 
            min-height: 100vh; 
            display: flex; 
        }
        h1, h2, h3, h4 { color: var(--text-dark); margin-bottom: 10px; transition: color var(--transition-duration); font-weight: 700; }
        .muted-text { color: var(--text-muted); font-size: 0.9rem; }
        
        .card, .form-card {
            background-color: var(--bg-medium);
            padding: 20px;
            border-radius: var(--border-radius-card);
            box-shadow: var(--shadow-soft);
            transition: all var(--transition-duration);
        }
        .mt-20 { margin-top: 20px; }
        .empty-message { text-align: center; padding: 40px; color: var(--text-muted); font-style: italic; }

        /* General Inputs & Buttons */
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            background-color: var(--bg-accent); /* Use light accent for input background */
            border-radius: var(--border-radius-input);
            padding: 0 10px;
            border: 1px solid transparent;
            transition: border-color var(--transition-duration);
        }
        .input-group:focus-within { border-color: var(--color-primary); }
        .input-group i { color: var(--text-muted); margin-right: 10px; }
        .input-group input, .input-group select, .input-group textarea {
            border: none;
            padding: 10px 0;
            background: transparent;
            color: var(--text-dark);
            flex-grow: 1;
            font-size: 1rem;
            outline: none;
        }
        .btn {
            padding: 10px 20px;
            border-radius: var(--border-radius-input);
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color var(--transition-duration), transform 0.1s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .primary-btn { background-color: var(--color-primary); color: white; }
        .primary-btn:hover { background-color: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); }
        .success-btn { background-color: var(--color-success); color: white; }
        .success-btn:hover { background-color: #059669; transform: translateY(-1px); }
        .danger-btn { background-color: var(--color-danger); color: white; }
        .warning-btn { background-color: var(--color-warning); color: var(--text-dark); }


        /* Layout containers */
        #content-wrapper { 
            flex-grow: 1; 
            min-height: 100vh; 
            padding: 25px 35px; /* Slightly more padding */
            background-color: var(--bg-light); 
            transition: background-color var(--transition-duration); 
            width: calc(100% - var(--sidebar-width)); 
        }
        
        .app-view { max-width: 1200px; margin: 0 auto; min-height: calc(100vh - 50px); display: none; }
        .app-view.active { display: block; animation: fadeIn 0.4s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sidebar */
        #sidebar { 
            width: var(--sidebar-width); 
            background-color: var(--bg-medium); 
            padding: 25px 15px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            box-shadow: 6px 0 15px rgba(0, 0, 0, 0.05); /* Modern sidebar shadow */
            transition: all 0.3s ease-in-out; 
            flex-shrink: 0;
            z-index: 1000; 
        }
        .sidebar-header { margin-bottom: 30px; }
        .sidebar-header h3 { color: var(--color-primary); margin: 0; font-size: 1.5rem; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu a {
            display: flex; align-items: center; gap: 15px;
            padding: 12px 10px; margin-bottom: 8px;
            text-decoration: none; color: var(--text-dark);
            border-radius: var(--border-radius-input);
            transition: all 0.2s;
            font-weight: 500;
        }
        .sidebar-menu a:hover { background-color: var(--bg-accent); }
        .sidebar-menu a.active { 
            background-color: var(--color-primary); 
            color: white; 
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); 
        }
        .sidebar-menu a.active i { stroke: white; }
        .sidebar-footer { padding-top: 20px; border-top: 1px solid var(--bg-dark); }


        /* Student Card/List Styles (Modernized) */
        .student-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .student-card {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            position: relative;
            padding: 15px;
        }
        .student-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); 
        }
        
        /* New Character Avatars */
        .student-card .avatar {
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; /* Larger icon */
            font-weight: 700; color: white;
            flex-shrink: 0;
            border: 3px solid var(--bg-light); /* Outer ring */
            box-shadow: 0 0 0 3px var(--bg-medium);
        }
        .student-card .info { flex-grow: 1; overflow: hidden; }
        .student-card .info h4 { margin: 0; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .student-card .info p { margin: 0; font-size: 0.8rem; color: var(--text-muted); }
        .student-card .stars {
            display: flex; align-items: center; gap: 5px;
            font-weight: 700; color: var(--color-star);
            flex-shrink: 0;
            font-size: 1.2rem;
        }
        .quick-action-btn {
            position: absolute;
            top: 5px; right: 5px;
            padding: 5px 12px;
            font-size: 0.8rem;
            font-weight: 700;
            border-radius: 20px;
        }
        .quick-action-btn span { margin-left: 2px; }

        /* Dashboard Recognition Grid */
        .recognition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .recognition-card { text-align: center; border-radius: var(--border-radius-card); }
        .recognition-card h3 { font-size: 1.2rem; }
        .mini-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: 700; color: white;
            margin: 15px auto;
            border: 4px solid var(--color-star);
        }
        .recognition-card.leader .mini-avatar { 
            border-color: gold; 
            box-shadow: 0 0 0 3px gold, 0 0 15px rgba(255, 215, 0, 0.6);
        }
        .recognition-card.empty .mini-avatar { border-color: var(--text-muted); }


        /* Badges Styling */
        .badge-icon-lg { background-color: var(--color-badge); }
        .badge-item { background-color: var(--color-badge); }

        /* Modals (Enhanced) */
        .modal-content {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .profile-avatar {
            width: 110px; height: 110px; 
            border: 6px solid var(--color-star);
            font-size: 3rem;
        }
        .profile-stars { font-size: 1.8rem; }
        .history-timeline { 
            max-height: 300px; 
            border: 1px solid var(--bg-dark);
            border-radius: var(--border-radius-input);
            padding: 10px;
        }
        .history-timeline::-webkit-scrollbar { width: 8px; }
        .history-timeline::-webkit-scrollbar-thumb { background-color: var(--text-muted); border-radius: 10px; }
        .history-timeline::-webkit-scrollbar-track { background: var(--bg-accent); }

        /* --- 4. RESPONSIVENESS (Mobile View Fixes) --- */
        .mobile-only { display: none; }
        .list-controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }

        @media (max-width: 900px) {
            #content-wrapper { padding: 20px; width: 100%; }
            .recognition-grid { 
                grid-template-columns: 1fr; 
                max-width: 450px; 
                margin-left: auto; 
                margin-right: auto;
            }
        }
        
        @media (max-width: 768px) {
            body { 
                display: block; 
                position: relative;
            } 

            #sidebar { 
                position: fixed; 
                height: 100vh; 
                width: 100%;
                max-width: 300px;
                transform: translateX(-100%); 
                box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2); 
                z-index: 1010;
            }
            #sidebar.active { 
                transform: translateX(0); 
            }
            
            #content-wrapper { 
                padding-top: 80px; 
            }
            
            .mobile-only { 
                display: block; 
                position: fixed; 
                top: 15px; 
                left: 15px; 
                z-index: 1020; 
            }
            
            .list-controls { flex-direction: column; }
            .input-group.search-group { margin-bottom: 10px; }
            .modal-content { 
                margin: 20px auto; 
                max-width: 95%; 
                padding: 20px;
            }
            .student-list-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-theme="light" data-color="blue">
    
    <nav id="sidebar">
        <div>
            <div class="sidebar-header">
                <h3>Star Zone ‚ú®</h3>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" data-target="dashboard-view" class="nav-item active"><i data-feather="grid"></i> Dashboard</a></li>
                <li><a href="#" data-target="student-list-view" class="nav-item"><i data-feather="users"></i> Student Roster</a></li>
                <li><a href="#" data-target="badges-view" class="nav-item"><i data-feather="award"></i> Badges & Rewards</a></li> 
                <li><a href="#" data-target="add-student-view" class="nav-item"><i data-feather="user-plus"></i> Enroll Student</a></li>
                <li><a href="#" data-target="settings-view" class="nav-item"><i data-feather="settings"></i> Settings</a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <button id="dark-mode-toggle" class="icon-btn btn primary-btn" title="Toggle Dark Mode">
                <i data-feather="moon"></i>
            </button>
            <p class="muted-text" style="font-size: 0.75rem;">v1.3.0</p>
        </div>
    </nav>

    <div id="content-wrapper">
        <button id="mobile-menu-toggle" class="icon-btn mobile-only primary-btn"><i data-feather="menu"></i></button>

        <div id="dashboard-view" class="app-view active page-view">
            <h2>Welcome to the Star Zone!</h2>

            <div class="card" style="padding: 15px; border-left: 5px solid var(--color-warning); margin-top: 15px;">
                <h3 id="daily-quote" style="font-size: 1rem; margin: 0;"></h3>
                <p id="quote-author" class="muted-text" style="text-align: right; margin-top: 5px; font-style: italic;"></p>
            </div>

            <h2 class="mt-20">Star Achievers</h2>
            <div class="recognition-grid">
                
                <div class="recognition-card card" id="student-month-card">
                    <h3>‚≠ê Month's Top Star</h3>
                    <div class="mini-avatar" id="month-avatar">?</div>
                    <p id="month-name" style="font-weight: 600;"></p>
                    <span class="muted-text" id="month-stars"></span>
                </div>

                <div class="recognition-card card" id="student-week-card">
                    <h3>‚ú® Week's Shining Star</h3>
                    <div class="mini-avatar" id="week-avatar">?</div>
                    <p id="week-name" style="font-weight: 600;"></p>
                    <span class="muted-text" id="week-stars"></span>
                </div>

                <div class="recognition-card card leader" id="top-leader-card">
                    <h3>üèÜ All-Time Champion</h3>
                    <div class="mini-avatar" id="leader-avatar">?</div>
                    <p id="leader-name" style="font-weight: 600;"></p>
                    <span id="leader-stars" style="font-weight: 700; color: var(--color-star);"></span>
                </div>

            </div>
        </div>

        <div id="student-list-view" class="app-view page-view">
            <h2>Student Roster</h2>
            <div class="list-controls">
                <div class="input-group search-group" style="flex-grow: 1;">
                    <i data-feather="search"></i>
                    <input type="text" id="student-search" placeholder="Search by name...">
                </div>
                <div class="input-group" style="min-width: 120px; max-width: 200px;"><select id="class-filter"></select></div>
                <div class="input-group" style="min-width: 150px; max-width: 250px;"><select id="sort-filter">
                    <option value="stars-desc">‚≠ê Stars (High)</option>
                    <option value="name-asc">A-Z Name</option>
                    <option value="roll-asc">Roll No.</option>
                </select></div>
            </div>
            <div id="student-list-container" class="student-list-grid">
                <p id="no-students-message" class="empty-message">No students found. Use the 'Enroll Student' tab to add one!</p>
            </div>
        </div>
        
        <div id="badges-view" class="app-view page-view">
            <h2>Achievement Badges üèÖ</h2>
            <p class="muted-text">Unlock these rewards by completing different star milestones and actions.</p>
            <div id="all-badges-container" class="badge-list-grid mt-20">
                </div>
        </div>


        <div id="add-student-view" class="app-view page-view">
            <h2>Enroll New Student</h2>
            <form id="add-student-form" class="form-card" style="max-width: 500px;">
                <div class="input-group"><i data-feather="user"></i><input type="text" id="add-name" placeholder="Full Name" required></div>
                <div class="input-group">
                    <i data-feather="user-check"></i>
                    <select id="add-gender" required style="cursor: pointer;">
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group"><i data-feather="bookmark"></i><input type="text" id="add-class" placeholder="Class (e.g., 5A)" required></div>
                <div class="input-group"><i data-feather="hash"></i><input type="number" id="add-roll" placeholder="Roll Number" required></div>
                <div class="input-group"><i data-feather="calendar"></i><input type="date" id="add-dob" placeholder="Date of Birth (Optional)"></div>
                <div class="input-group"><i data-feather="star"></i><input type="number" id="add-stars" placeholder="Initial Stars (e.g., 0)" value="0"></div>
                <button type="submit" class="btn primary-btn large-btn"><i data-feather="user-plus"></i> Enroll Student</button>
            </form>
        </div>

        <div id="settings-view" class="app-view page-view">
            <h2>Settings ‚öôÔ∏è</h2>
            <div class="settings-group">
                <h3>Security</h3>
                <form id="change-password-form" class="form-card" style="max-width: 500px;">
                    <p class="muted-text">Set/Change a 4-digit Teacher PIN (Optional - for securing settings/data).</p>
                    <div class="input-group">
                        <i data-feather="lock"></i>
                        <input type="password" id="new-password" placeholder="New PIN (4+ digits)" required>
                    </div>
                    <button type="submit" class="btn primary-btn">Update PIN</button>
                    <button type="button" id="remove-password-btn" class="btn danger-btn-icon mt-10"><i data-feather="slash"></i> Remove PIN Security</button>
                </form>
            </div>

            <div class="settings-group">
                <h3>Theme & Data</h3>
                <div class="form-card" style="max-width: 500px;">
                    <p class="muted-text">Select Primary Color:</p>
                    <div class="theme-picker" style="display: flex; gap: 15px; margin-top: 10px;">
                        <div class="theme-option theme-blue active" data-color="blue" title="Blue Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #3b82f6;"></div>
                        <div class="theme-option theme-purple" data-color="purple" title="Purple Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #a78bfa;"></div>
                        <div class="theme-option theme-green" data-color="green" title="Green Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #10b981;"></div>
                    </div>
                </div>
                <div class="form-card mt-20" style="max-width: 500px;">
                    <p class="muted-text">Import / Export Data</p>
                    <button id="export-data-btn" class="btn primary-btn" style="margin-right: 10px;"><i data-feather="download"></i> Export Data</button>
                    <input type="file" id="import-file" accept="application/json" class="file-input" style="display: none;">
                    <button id="import-data-trigger" class="btn warning-btn" style="margin-top: 10px;"><i data-feather="upload"></i> Import Data</button>
                </div>
            </div>
            
            <div class="settings-group danger-zone mt-20">
                <h3>Danger Zone</h3>
                <div class="form-card danger-card" style="border: 1px dashed var(--color-danger); max-width: 500px;">
                    <p class="muted-text">Permanently delete all students, history, and notes (excluding the optional PIN).</p>
                    <button id="full-reset-btn" class="btn danger-btn large-btn mt-15"><i data-feather="trash-2"></i> Full App Data Reset</button>
                </div>
            </div>
        </div>

    </div> <div id="profile-modal" class="modal">
        <div class="modal-content profile-content">
            <button class="close-btn" id="close-profile-modal"><i data-feather="x"></i></button>
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar"></div>
                <h2 id="profile-name"></h2>
                <p class="muted-text"><span id="profile-class"></span>, Roll: <span id="profile-roll"></span></p>
                <p class="muted-text" id="profile-dob">DOB: N/A</p>
            </div>
            
            <div class="profile-stars">
                <i data-feather="star" class="star-icon" fill="var(--color-star)" style="width: 30px; height: 30px;"></i>
                Total Stars: <span id="profile-star-count">0</span>
            </div>
            
            <div class="profile-section card" style="margin-top: 20px;">
                <h3 style="display: flex; align-items: center; gap: 8px;"><i data-feather="award" style="stroke: var(--color-badge);"></i> Earned Badges (<span id="profile-badge-count">0</span>)</h3>
                <div id="student-badges-container" class="badge-display-grid">
                    <p id="no-badges-message" class="muted-text" style="width: 100%; text-align: center;">No achievements unlocked yet.</p>
                </div>
            </div>

            <div class="profile-actions card" style="margin-top: 20px; border: 1px solid var(--bg-dark);">
                <h3>Star Actions</h3>
                <div class="action-group" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn success-btn star-btn" data-action="add-star" style="flex: 1;"><i data-feather="plus"></i> Add Stars</button>
                    <button class="btn danger-btn star-btn" data-action="remove-star" style="flex: 1;"><i data-feather="minus"></i> Remove Stars</button>
                </div>
            </div>

            <div class="profile-section" style="margin-top: 20px;">
                <button id="edit-student-btn" class="btn primary-btn large-btn" style="width: 100%;"><i data-feather="edit-3"></i> Edit Student Details</button>
            </div>

            <div class="profile-section" style="margin-top: 20px;">
                <h3><i data-feather="clock"></i> Star History Timeline</h3>
                <div id="star-history-timeline" class="history-timeline"></div>
            </div>
            
            <button id="delete-student-btn" class="btn danger-btn mt-20 large-btn" style="width: 100%;"><i data-feather="trash-2"></i> Delete Student</button>
        </div>
    </div>

    <div id="star-action-modal" class="modal">
        <div class="modal-content star-action-content">
            <button class="close-btn" id="close-star-action-modal"><i data-feather="x"></i></button>
            <h2 id="star-action-title"></h2>
            <form id="star-action-form">
                <input type="hidden" id="star-action-type">
                <input type="hidden" id="star-action-student-id">
                
                <div class="input-group">
                    <i data-feather="star"></i>
                    <input type="number" id="star-amount" placeholder="Number of Stars (1+)" min="1" required>
                </div>
                
                <textarea id="star-reason" placeholder="Reason/Comment (e.g., 'Excellent presentation')" style="min-height: 80px; width: 100%; margin-bottom: 15px; padding: 10px; border-radius: var(--border-radius-input); border: 1px solid var(--bg-dark); background-color: var(--bg-accent);"></textarea>
                
                <p id="star-action-info" class="muted-text"></p>
                
                <button type="submit" id="star-submit-btn" class="btn primary-btn large-btn mt-15" style="width: 100%;">
                    <i data-feather="check"></i> Confirm Action
                </button>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" id="close-edit-modal"><i data-feather="x"></i></button>
            <h2>Edit Student Details</h2>
            <form id="edit-student-form" class="form-card">
                <input type="hidden" id="edit-id">
                <div class="input-group"><i data-feather="user"></i><input type="text" id="edit-name" placeholder="Name" required></div>
                <div class="input-group">
                    <i data-feather="user-check"></i>
                    <select id="edit-gender" required style="cursor: pointer; flex-grow: 1;">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group"><i data-feather="bookmark"></i><input type="text" id="edit-class" placeholder="Class (e.g., 5B)" required></div>
                <div class="input-group"><i data-feather="hash"></i><input type="number" id="edit-roll" placeholder="Roll Number" required></div>
                <div class="input-group"><i data-feather="calendar"></i><input type="date" id="edit-dob" title="Date of Birth"></div>
                <button type="submit" class="btn primary-btn" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>
    
    <script>
        
        // --- DATA RESOURCES ---
        const DAILY_QUOTES = [
            { quote: "Science is the great antidote to the poison of enthusiasm and superstition.", author: "Adam Smith" },
            { quote: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
            { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { quote: "Try not to become a man of success, but rather try to become a man of value.", author: "Albert Einstein" },
            { quote: "Where there is a will, there is a way.", author: "Pauline Kael" },
            { quote: "An investment in knowledge always pays the best interest.", author: "Benjamin Franklin" },
            { quote: "Logic will get you from A to Z; imagination will get you everywhere.", author: "Albert Einstein" },
        ];
        
        // --- CHARACTER/AVATAR RESOURCES (New) ---
        const CHARACTERS = {
            MALE_ICON: '&#128102;', // üë¶ (Boy emoji)
            FEMALE_ICON: '&#128103;', // üëß (Girl emoji)
            MALE_COLOR: 'var(--avatar-color-male)', 
            FEMALE_COLOR: 'var(--avatar-color-female)',
            
            getAvatar: (gender) => {
                return gender === 'female' ? CHARACTERS.FEMALE_ICON : CHARACTERS.MALE_ICON;
            },
            getColor: (gender) => {
                return gender === 'female' ? CHARACTERS.FEMALE_COLOR : CHARACTERS.MALE_COLOR;
            }
        };


        // --- BADGE DEFINITIONS ---
        const BADGES_LIST = [
            { id: 'first_star', name: 'First Star', description: 'Awarded after receiving the very first star.', icon: 'award', type: 'star_count', count: 1 },
            { id: 'star_centurion', name: 'Star Centurion', description: 'Reached 100 total stars.', icon: 'shield', type: 'star_count', count: 100 },
            { id: 'star_master', name: 'Star Master', description: 'Reached 500 total stars.', icon: 'zap', type: 'star_count', count: 500 },
            { id: 'early_bird', name: 'Early Bird', description: 'Awarded stars on a Monday (start of the school week).', icon: 'sun', type: 'history_day', day: 1 }, // 1 is Monday
            { id: 'full_circle', name: 'Full Circle', description: 'Has received 10 or more stars in both "add" and "remove" actions.', icon: 'refresh-ccw', type: 'history_balance', count: 10 },
            { id: 'power_hitter', name: 'Power Hitter', description: 'Received 50 or more stars in a single action.', icon: 'battery-charging', type: 'history_single_add', count: 50 },
        ];


        // --- 1. State Module (Manages app data and persistence) ---
        const StateModule = (function() {
            const STATE_KEYS = {
                STUDENTS: 'starManager_students_v7', // Bumped version for new gender/character data
                HISTORY: 'starManager_starHistory_v7',
                PASSWORD: 'starManager_teacherPassword_v2', 
                THEME: 'starManager_themeMode_v2',
                COLOR: 'starManager_colorTheme_v2',
                LAST_QUOTE_INDEX: 'starManager_lastQuoteIndex_v1',
                LAST_QUOTE_DATE: 'starManager_lastQuoteDate_v1',
            };

            // Added 'gender' property to demo data
            const DEMO_STUDENTS = [
                { id: 's1', name: 'Maya Sharma', class: '5A', roll: 12, stars: 300, dob: '2015-05-15', gender: 'female', avatar: CHARACTERS.getAvatar('female'), badges: ['first_star', 'star_centurion'] }, 
                { id: 's2', name: 'Rohan Singh', class: '5A', roll: 9, stars: 150, dob: '2016-01-20', gender: 'male', avatar: CHARACTERS.getAvatar('male'), badges: ['first_star', 'star_centurion'] }, 
                { id: 's3', name: 'Priya Verma', class: '6B', roll: 4, stars: 210, dob: '2015-11-01', gender: 'female', avatar: CHARACTERS.getAvatar('female'), badges: ['first_star', 'star_centurion'] },
                { id: 's4', name: 'Arjun Das', class: '6B', roll: 18, stars: 55, dob: '2016-03-29', gender: 'male', avatar: CHARACTERS.getAvatar('male'), badges: ['first_star'] },
                { id: 's5', name: 'Zoe Khan', class: '5A', roll: 30, stars: 490, dob: '2015-08-01', gender: 'female', avatar: CHARACTERS.getAvatar('female'), badges: ['first_star', 'star_centurion', 'power_hitter'] },
            ];
            
            const getDemoHistory = () => {
                const now = new Date();
                const monthAgo = new Date(now); monthAgo.setDate(now.getDate() - 35);
                const twoDaysAgo = new Date(now); twoDaysAgo.setDate(now.getDate() - 2);
                const mondayAgo = new Date(now); mondayAgo.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1)); // Last Monday
                mondayAgo.setHours(10,0,0,0);


                return [
                    { studentId: 's5', type: 'add', stars: 100, date: monthAgo.toISOString(), reason: 'Big project completion (Power Hitter)' },
                    { studentId: 's5', type: 'remove', stars: 20, date: twoDaysAgo.toISOString(), reason: 'Tardiness' },
                    { studentId: 's2', type: 'add', stars: 50, date: mondayAgo.toISOString(), reason: 'Excellent presentation (Early Bird)' },
                    { studentId: 's1', type: 'add', stars: 10, date: new Date().toISOString(), reason: 'Good participation' },
                    { studentId: 's3', type: 'remove', stars: 5, date: new Date().toISOString(), reason: 'Late submission' },
                ];
            };


            let appState = {
                students: [],
                starHistory: [],
                teacherPassword: null, 
                themeMode: 'light', 
                colorTheme: 'blue',
                quote: DAILY_QUOTES[0], 
            };
            
            let currentModalStudentId = null;

            function saveState() {
                try {
                    localStorage.setItem(STATE_KEYS.STUDENTS, JSON.stringify(appState.students));
                    localStorage.setItem(STATE_KEYS.HISTORY, JSON.stringify(appState.starHistory));
                    localStorage.setItem(STATE_KEYS.PASSWORD, appState.teacherPassword);
                    localStorage.setItem(STATE_KEYS.THEME, appState.themeMode);
                    localStorage.setItem(STATE_KEYS.COLOR, appState.colorTheme);
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                }
            }

            function getDailyQuote() {
                const today = new Date().toDateString();
                const lastDate = localStorage.getItem(STATE_KEYS.LAST_QUOTE_DATE);
                let lastIndex = parseInt(localStorage.getItem(STATE_KEYS.LAST_QUOTE_INDEX)) || 0;
                
                if (today !== lastDate) {
                    lastIndex = (lastIndex + 1) % DAILY_QUOTES.length;
                    localStorage.setItem(STATE_KEYS.LAST_QUOTE_DATE, today);
                    localStorage.setItem(STATE_KEYS.LAST_QUOTE_INDEX, lastIndex.toString());
                }
                
                appState.quote = DAILY_QUOTES[lastIndex];
            }

            function loadState() {
                try {
                    appState.teacherPassword = localStorage.getItem(STATE_KEYS.PASSWORD) || null;
                    appState.themeMode = localStorage.getItem(STATE_KEYS.THEME) || appState.themeMode;
                    appState.colorTheme = localStorage.getItem(STATE_KEYS.COLOR) || appState.colorTheme;
                    
                    const storedStudents = JSON.parse(localStorage.getItem(STATE_KEYS.STUDENTS));
                    const storedHistory = JSON.parse(localStorage.getItem(STATE_KEYS.HISTORY));

                    if (storedStudents && storedStudents.length > 0) {
                        // Ensure required fields for UI are present
                        appState.students = storedStudents.map(s => ({
                            ...s, 
                            badges: s.badges || [],
                            gender: s.gender || 'male', // Default to male if missing
                            avatar: s.avatar || CHARACTERS.getAvatar(s.gender || 'male')
                        })); 
                        appState.starHistory = storedHistory || [];
                    } else {
                        appState.students = DEMO_STUDENTS;
                        appState.starHistory = getDemoHistory();
                    }
                    getDailyQuote(); 
                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                    appState.students = DEMO_STUDENTS;
                    appState.starHistory = getDemoHistory();
                }
            }
            
            // --- DATA UTILITIES (For Import/Export) ---
            function exportData() {
                const data = {
                    students: appState.students,
                    starHistory: appState.starHistory,
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `star_manager_export_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function importData(jsonString) {
                try {
                    const data = JSON.parse(jsonString);
                    if (!data.students || !Array.isArray(data.students)) {
                        throw new Error("Invalid import file structure. Missing 'students' array.");
                    }
                    
                    if (confirm(`Importing ${data.students.length} students. This will OVERWRITE current data. Continue?`)) {
                         appState.students = data.students.map(s => ({
                            ...s, 
                            badges: s.badges || [],
                            gender: s.gender || 'male', 
                            avatar: s.avatar || CHARACTERS.getAvatar(s.gender || 'male')
                        }));
                        appState.starHistory = data.starHistory || []; 
                        saveState();
                        return true;
                    }
                    return false;
                } catch (e) {
                    console.error("Import Error:", e);
                    return false;
                }
            }


            return {
                appState,
                saveState,
                loadState,
                DEMO_STUDENTS,
                STATE_KEYS,
                getCurrentStudentId: () => currentModalStudentId,
                setCurrentStudentId: (id) => { currentModalStudentId = id; },
                exportData,
                importData,
            };
        })();


        // --- 2. Badge Module ---
        const BadgeModule = (function(State) {
            
            function checkStarCountBadge(student, badge) {
                return student.stars >= badge.count;
            }

            function checkHistoryDayBadge(student, badge) {
                return State.appState.starHistory.some(log => {
                    if (log.studentId === student.id && log.type === 'add') {
                        const dayOfWeek = new Date(log.date).getDay();
                        return dayOfWeek === badge.day; 
                    }
                    return false;
                });
            }
            
            function checkHistoryBalanceBadge(student, badge) {
                const studentHistory = State.appState.starHistory.filter(log => log.studentId === student.id);
                const totalAdded = studentHistory.filter(log => log.type === 'add').reduce((sum, log) => sum + log.stars, 0);
                const totalRemoved = studentHistory.filter(log => log.type === 'remove').reduce((sum, log) => sum + log.stars, 0);
                
                return totalAdded >= badge.count && totalRemoved >= badge.count;
            }

            function checkHistorySingleAddBadge(student, badge) {
                return State.appState.starHistory.some(log => {
                    if (log.studentId === student.id && log.type === 'add') {
                        return log.stars >= badge.count;
                    }
                    return false;
                });
            }


            function checkAndAwardBadges(studentId) {
                const student = State.appState.students.find(s => s.id === studentId);
                if (!student) return;

                let newlyAwarded = [];

                BADGES_LIST.forEach(badge => {
                    if (student.badges.includes(badge.id)) return;

                    let criteriaMet = false;

                    switch (badge.type) {
                        case 'star_count':
                            criteriaMet = checkStarCountBadge(student, badge);
                            break;
                        case 'history_day':
                            criteriaMet = checkHistoryDayBadge(student, badge);
                            break;
                        case 'history_balance':
                            criteriaMet = checkHistoryBalanceBadge(student, badge);
                            break;
                        case 'history_single_add':
                             criteriaMet = checkHistorySingleAddBadge(student, badge);
                            break;
                    }

                    if (criteriaMet) {
                        student.badges.push(badge.id);
                        newlyAwarded.push(badge);
                    }
                });

                if (newlyAwarded.length > 0) {
                    State.saveState();
                    newlyAwarded.forEach(badge => {
                        window.UIModule.showToast(`New Badge Unlocked: ${badge.name}`, 'badge-awarded', badge.icon);
                    });
                    return true;
                }
                return false;
            }
            
            function checkAllStudentsForBadges() {
                let awardedCount = 0;
                State.appState.students.forEach(s => {
                    if (checkAndAwardBadges(s.id)) awardedCount++;
                });
                if (awardedCount > 0) State.saveState();
            }

            return {
                checkAndAwardBadges,
                checkAllStudentsForBadges,
                BADGES_LIST
            };
        })(StateModule);

        
        // --- 3. UI Module (Handles view navigation, modals, and toasts) ---
        const UIModule = (function(State, Badge) {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            
            function uuid() {
                return Date.now().toString(36) + Math.random().toString(36).substring(2);
            }

            function getTodayDateString() {
                return new Date().toISOString(); 
            }
            
            function showToast(message, type = 'primary', icon = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const toastTypeClass = type === 'badge-awarded' ? 'badge-awarded' : type;
                toast.className = `toast ${toastTypeClass}`;
                toast.innerHTML = `<i data-feather="${icon}"></i> ${message}`;
                
                container.appendChild(toast);
                feather.replace();

                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            function navigate(targetViewId) {
                const isSensitiveArea = (targetViewId === 'settings-view'); 
                const hasPassword = !!State.appState.teacherPassword;
                
                if (isSensitiveArea && hasPassword) {
                    const pin = prompt("Enter Teacher PIN to access settings:");
                    if (pin !== State.appState.teacherPassword) {
                        showToast("Access Denied: Incorrect PIN.", 'danger', 'lock');
                        return;
                    }
                }
                
                document.querySelectorAll('.app-view').forEach(view => {
                    view.classList.remove('active');
                });
                
                const targetView = document.getElementById(targetViewId);
                if (targetView) {
                    targetView.classList.add('active');
                    
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    document.querySelector(`.nav-item[data-target="${targetViewId}"]`)?.classList.add('active');
                    
                    if (sidebar.classList.contains('active') && window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                    }
                    
                    if (window.RenderModule) {
                        if (targetViewId === 'dashboard-view') window.RenderModule.renderDashboardRecognition();
                        if (targetViewId === 'student-list-view') window.RenderModule.renderStudentList(); 
                        if (targetViewId === 'badges-view') window.RenderModule.renderBadgesView(); 
                    }
                }
            }
            
            function openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
                document.body.style.overflow = 'hidden'; 
                feather.replace();
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                if (document.querySelectorAll('.modal.active').length === 0) {
                     document.body.style.overflow = '';
                }
            }
            
            function renderStudentBadges(student) {
                const container = document.getElementById('student-badges-container');
                const badgeCount = document.getElementById('profile-badge-count');
                const noBadgesMessage = document.getElementById('no-badges-message');
                
                badgeCount.textContent = student.badges.length;

                if (student.badges.length === 0) {
                    container.innerHTML = '';
                    noBadgesMessage.style.display = 'block';
                    return;
                }
                
                noBadgesMessage.style.display = 'none';
                container.innerHTML = student.badges.map(badgeId => {
                    const badge = Badge.BADGES_LIST.find(b => b.id === badgeId);
                    if (!badge) return '';
                    return `
                        <div class="badge-item" title="${badge.description}">
                            <i data-feather="${badge.icon}" style="fill: currentColor;"></i>
                            ${badge.name}
                        </div>
                    `;
                }).join('');
                feather.replace();
            }

            function openProfileModal(studentId) {
                const student = State.appState.students.find(s => s.id === studentId);
                if (!student) return;

                State.setCurrentStudentId(studentId);
                const dobText = student.dob 
                    ? new Date(student.dob + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
                    : 'N/A';
                
                // RENDER CHARACTER AVATAR
                const avatarEl = document.getElementById('profile-avatar');
                avatarEl.innerHTML = CHARACTERS.getAvatar(student.gender);
                avatarEl.style.backgroundColor = CHARACTERS.getColor(student.gender);

                document.getElementById('profile-name').textContent = student.name;
                document.getElementById('profile-class').textContent = `Class: ${student.class}`;
                document.getElementById('profile-roll').textContent = student.roll;
                document.getElementById('profile-dob').textContent = `DOB: ${dobText}`; 
                document.getElementById('profile-star-count').textContent = student.stars;
                
                // RENDER BADGES
                renderStudentBadges(student); 

                // Render Star History
                const historyContainer = document.getElementById('star-history-timeline');
                const studentHistory = State.appState.starHistory
                    .filter(log => log.studentId === studentId)
                    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

                if (studentHistory.length === 0) {
                    historyContainer.innerHTML = '<p id="no-history-message" class="muted-text" style="text-align: center;">No star history yet.</p>';
                } else {
                    historyContainer.innerHTML = studentHistory.map(log => {
                        const dateFormatted = new Date(log.date).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); 
                        const actionType = log.type === 'add' ? 'Awarded' : 'Removed';
                        const colorClass = log.type === 'add' ? 'success' : 'danger';

                        return `
                        <div class="history-item ${colorClass}" style="border-bottom: 1px dashed var(--bg-dark); padding: 5px 0; font-size: 0.9rem;">
                            <span style="font-weight:700; color: var(--color-${colorClass});">${actionType} ${log.stars} Star${log.stars > 1 ? 's' : ''}</span>
                            <span class="muted-text"> (${log.reason || 'No reason provided'})</span>
                            <p class="date" style="font-size: 0.8rem; color: var(--text-muted);">${dateFormatted}</p>
                        </div>
                    `;
                    }).join('');
                }

                openModal('profile-modal');
            }
            
            function openEditModal(studentId) {
                const student = State.appState.students.find(s => s.id === studentId);
                if (!student) return;

                document.getElementById('edit-id').value = student.id;
                document.getElementById('edit-name').value = student.name;
                document.getElementById('edit-class').value = student.class;
                document.getElementById('edit-roll').value = student.roll;
                document.getElementById('edit-dob').value = student.dob || ''; 
                document.getElementById('edit-gender').value = student.gender || 'male';

                closeModal('profile-modal'); 
                openModal('edit-modal');
            }

            function openStarActionModal(type, studentId) {
                const student = State.appState.students.find(s => s.id === studentId);
                if (!student) return;

                const title = type === 'add' ? `Award Stars to ${student.name}` : `Remove Stars from ${student.name}`;
                const info = type === 'add' 
                    ? `Award stars for positive action.`
                    : `Deduct stars. Current count: ${student.stars}.`;
                const btnClass = type === 'add' ? 'success-btn' : 'danger-btn';
                
                document.getElementById('star-action-title').textContent = title;
                document.getElementById('star-action-info').textContent = info;
                document.getElementById('star-action-type').value = type;
                document.getElementById('star-action-student-id').value = studentId;
                document.getElementById('star-submit-btn').className = `btn ${btnClass} large-btn mt-15`;
                
                document.getElementById('star-amount').value = '';
                document.getElementById('star-reason').value = '';

                const profileOpen = document.getElementById('profile-modal').classList.contains('active');
                if (profileOpen) {
                    closeModal('profile-modal'); 
                }
                State.setCurrentStudentId(studentId); 

                openModal('star-action-modal');
            }


            function updateThemeUI() {
                const body = document.body;
                body.setAttribute('data-theme', State.appState.themeMode);
                body.setAttribute('data-color', State.appState.colorTheme);

                const toggleIcon = State.appState.themeMode === 'dark' ? 'sun' : 'moon';
                const toggleButton = document.getElementById('dark-mode-toggle');
                if (toggleButton) {
                    toggleButton.innerHTML = `<i data-feather="${toggleIcon}"></i>`;
                    feather.replace();
                }
                
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                    option.style.borderColor = 'transparent';

                    if (option.dataset.color === State.appState.colorTheme) {
                        option.classList.add('active');
                        option.style.borderColor = State.appState.themeMode === 'dark' ? 'white' : '#1f2937'; 
                    }
                });
            }

            return {
                navigate,
                showToast,
                uuid,
                getTodayDateString,
                openProfileModal,
                closeProfileModal: () => { closeModal('profile-modal'); window.RenderModule.renderAll(); State.setCurrentStudentId(null); },
                openEditModal,
                closeEditModal: () => { 
                    closeModal('edit-modal'); 
                    const currentId = State.getCurrentStudentId();
                    if(currentId) UIModule.openProfileModal(currentId); 
                    window.RenderModule.renderAll();
                },
                closeStarActionModal: () => { 
                    closeModal('star-action-modal'); 
                    const currentId = State.getCurrentStudentId();
                    if (currentId) UIModule.openProfileModal(currentId); 
                    window.RenderModule.renderAll();
                },
                openStarActionModal, 
                updateThemeUI,
                getSidebar: () => sidebar,
                getMobileMenuToggle: () => mobileMenuToggle,
                triggerConfetti: () => { /* Confetti logic simplified for brevity */ },
            };

        })(StateModule, BadgeModule);

        window.UIModule = UIModule; 


        // --- 4. Render Module ---
        const RenderModule = (function(State, UI, Badge) {

            function renderStudentCard(student) {
                return `
                    <div class="student-card card" data-student-id="${student.id}" title="${student.name} - ${student.stars} Stars">
                        <div class="avatar" style="background-color: ${CHARACTERS.getColor(student.gender)};">${CHARACTERS.getAvatar(student.gender)}</div>
                        <div class="info">
                            <h4>${student.name}</h4>
                            <p>Class: ${student.class} | Roll: ${student.roll}</p>
                            ${student.badges.length > 0 ? `<p style="color: var(--color-badge); font-weight: 600; font-size: 0.8rem; margin-top: 2px;">üèÖ ${student.badges.length} Badges</p>` : ''}
                        </div>
                        <div class="stars">
                            <i data-feather="star" fill="currentColor" style="width: 18px; height: 18px;"></i>
                            ${student.stars}
                        </div>
                        <button class="quick-action-btn btn success-btn" data-student-id="${student.id}" data-action="quick-star" title="Quick Add Star">
                            <i data-feather="plus" style="width: 14px; height: 14px;"></i><span>1</span>
                        </button>
                    </div>
                `;
            }

            function renderStudentList() {
                const container = document.getElementById('student-list-container');
                const search = document.getElementById('student-search').value.toLowerCase();
                const classFilter = document.getElementById('class-filter').value;
                const sortFilter = document.getElementById('sort-filter').value;
                const noStudentsMessage = document.getElementById('no-students-message');
                
                // 1. Prepare Classes for Filter
                const classes = [...new Set(State.appState.students.map(s => s.class))].sort();
                const classFilterSelect = document.getElementById('class-filter');
                if (classFilterSelect.innerHTML === '' || !classFilterSelect.querySelector('option[value=""]')) {
                    classFilterSelect.innerHTML = '<option value="">All Classes</option>';
                    classFilterSelect.innerHTML += classes.map(c => `<option value="${c}">${c}</option>`).join('');
                } else {
                    classes.forEach(c => {
                        if (!classFilterSelect.querySelector(`option[value="${c}"]`)) {
                             classFilterSelect.innerHTML += `<option value="${c}">${c}</option>`;
                        }
                    });
                }
                
                if (classFilter) classFilterSelect.value = classFilter;

                // 2. Filter Students
                let filteredStudents = State.appState.students.filter(student => {
                    const matchesSearch = student.name.toLowerCase().includes(search);
                    const matchesClass = !classFilter || student.class === classFilter;
                    return matchesSearch && matchesClass;
                });

                // 3. Sort Students
                filteredStudents.sort((a, b) => {
                    if (sortFilter === 'stars-desc') return b.stars - a.stars;
                    if (sortFilter === 'name-asc') return a.name.localeCompare(b.name);
                    if (sortFilter === 'roll-asc') return a.roll - b.roll;
                    return 0;
                });

                // 4. Render
                container.innerHTML = filteredStudents.map(renderStudentCard).join('');
                noStudentsMessage.style.display = filteredStudents.length === 0 ? 'block' : 'none';
                feather.replace();
            }
            
            function renderBadgesView() {
                const container = document.getElementById('all-badges-container');
                
                container.innerHTML = Badge.BADGES_LIST.map(badge => {
                    const earners = State.appState.students.filter(s => s.badges.includes(badge.id));
                    
                    return `
                        <div class="badge-card card" data-badge-id="${badge.id}">
                            <div class="badge-summary">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="badge-icon-lg"><i data-feather="${badge.icon}" fill="currentColor"></i></div>
                                    <h3>${badge.name}</h3>
                                </div>
                                <span class="badge-status" style="color: ${earners.length > 0 ? 'var(--color-success)' : 'var(--text-muted)'};">
                                    ${earners.length} Student${earners.length !== 1 ? 's' : ''}
                                </span>
                            </div>
                            <p class="badge-description">${badge.description}</p>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--bg-dark);">
                                <p style="font-size: 0.9rem; font-weight: 600; color: var(--text-dark);">Earners:</p>
                                <p class="muted-text" style="margin-top: 5px;">
                                    ${earners.length > 0 
                                        ? earners.map(s => s.name).join(', ') 
                                        : 'No one has unlocked this yet.'}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');

                feather.replace();
            }

            function getTopStudent(historyFilter) {
                const now = new Date();
                let historyThresholdDate = new Date(0); 

                if (historyFilter === 'week') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1)); 
                    startOfWeek.setHours(0, 0, 0, 0);
                    historyThresholdDate = startOfWeek;
                } else if (historyFilter === 'month') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    startOfMonth.setHours(0, 0, 0, 0);
                    historyThresholdDate = startOfMonth;
                }
                
                const historyThresholdTime = historyThresholdDate.getTime();
                const studentStarDelta = {};

                State.appState.students.forEach(s => { studentStarDelta[s.id] = 0; });

                State.appState.starHistory.forEach(log => {
                    const logDate = new Date(log.date).getTime(); 
                    if (logDate >= historyThresholdTime) { 
                        if (log.type === 'add') {
                            studentStarDelta[log.studentId] += log.stars;
                        } else if (log.type === 'remove') {
                            studentStarDelta[log.studentId] -= log.stars;
                        }
                    }
                });

                let topStudentId = null;
                let maxStars = -Infinity; 

                for (const id in studentStarDelta) {
                    if (studentStarDelta[id] > maxStars) {
                        maxStars = studentStarDelta[id];
                        topStudentId = id;
                    }
                }
                
                if (historyFilter === 'leader') {
                    const overallLeader = [...State.appState.students].sort((a, b) => b.stars - a.stars)[0];
                    return overallLeader ? { student: overallLeader, delta: overallLeader.stars } : null;
                }

                if (topStudentId && maxStars > 0) { 
                    const student = State.appState.students.find(s => s.id === topStudentId);
                    return { student, delta: maxStars };
                }

                return null;
            }

            function updateRecognitionCard(elementId, result) {
                const card = document.getElementById(elementId);
                const avatarEl = card.querySelector('.mini-avatar');
                const nameEl = card.querySelector('p');
                const starsEl = card.querySelector('.muted-text, span');
                
                if (result && result.student) {
                    const s = result.student;
                    const starsDisplay = elementId === 'top-leader-card' 
                        ? `${s.stars} Total Stars` 
                        : `+${result.delta} Stars Gained`;

                    avatarEl.innerHTML = CHARACTERS.getAvatar(s.gender);
                    avatarEl.style.backgroundColor = CHARACTERS.getColor(s.gender);
                    nameEl.textContent = s.name;
                    starsEl.textContent = starsDisplay;
                    card.classList.remove('empty');

                } else {
                    avatarEl.innerHTML = '‚ú®';
                    avatarEl.style.backgroundColor = 'var(--text-muted)';
                    nameEl.textContent = 'None Yet';
                    starsEl.textContent = 'No stars gained this period';
                    card.classList.add('empty');
                }
            }
            
            function renderDashboardRecognition() {
                // Update Quote of the Day
                document.getElementById('daily-quote').textContent = `"${State.appState.quote.quote}"`;
                document.getElementById('quote-author').textContent = `- ${State.appState.quote.author}`;

                // Student of the Month
                const monthResult = getTopStudent('month');
                updateRecognitionCard('student-month-card', monthResult);

                // Student of the Week
                const weekResult = getTopStudent('week');
                updateRecognitionCard('student-week-card', weekResult);

                // All-Time Top Leader (uses total stars)
                const leaderResult = getTopStudent('leader');
                updateRecognitionCard('top-leader-card', leaderResult);

                feather.replace();
            }


            function renderAll() {
                renderStudentList();
                renderDashboardRecognition();
                renderBadgesView(); 
                UI.updateThemeUI();
            }


            return {
                renderStudentList,
                renderDashboardRecognition,
                renderBadgesView,
                renderAll,
            };

        })(StateModule, UIModule, BadgeModule);
        
        window.RenderModule = RenderModule; 


        // --- 5. Handlers Module ---
        const HandlersModule = (function(State, UI, Render, Badge) {
            
            function handleAddStudent(e) {
                e.preventDefault();
                
                const name = document.getElementById('add-name').value.trim();
                const gender = document.getElementById('add-gender').value; // NEW
                const className = document.getElementById('add-class').value.trim();
                const roll = parseInt(document.getElementById('add-roll').value);
                const dob = document.getElementById('add-dob').value.trim(); 
                const initialStars = parseInt(document.getElementById('add-stars').value) || 0;

                if (!name || !className || isNaN(roll) || roll < 1 || !gender) {
                    UI.showToast("Error: Name, Gender, Class, and valid Roll Number are required.", 'danger', 'alert-triangle');
                    return;
                }
                
                const newStudent = {
                    id: UI.uuid(),
                    name: name,
                    class: className,
                    roll: roll,
                    dob: dob, 
                    stars: initialStars,
                    gender: gender,
                    avatar: CHARACTERS.getAvatar(gender), // Set avatar based on gender
                    badges: [] 
                };

                State.appState.students.push(newStudent);
                
                Badge.checkAndAwardBadges(newStudent.id); 
                State.saveState();
                
                document.getElementById('add-student-form').reset();
                UI.showToast(`Student ${name} enrolled successfully!`, 'success', 'user-check');
                UI.navigate('student-list-view');
            }

            function handleEditStudent(e) {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;
                const name = document.getElementById('edit-name').value.trim();
                const gender = document.getElementById('edit-gender').value; // NEW
                const className = document.getElementById('edit-class').value.trim();
                const roll = parseInt(document.getElementById('edit-roll').value);
                const dob = document.getElementById('edit-dob').value.trim(); 

                const student = State.appState.students.find(s => s.id === id);
                if (student) {
                    student.name = name;
                    student.class = className;
                    student.roll = roll;
                    student.dob = dob; 
                    student.gender = gender; // Update gender
                    student.avatar = CHARACTERS.getAvatar(gender); // Update avatar

                    Badge.checkAndAwardBadges(id); 

                    State.saveState();
                    UI.showToast(`Details for ${name} updated.`, 'success', 'edit');
                    UI.closeEditModal(); 
                }
            }

            function handleDeleteStudent() {
                if (State.appState.teacherPassword) {
                    const pin = prompt("Enter Teacher PIN to delete student:");
                    if (pin !== State.appState.teacherPassword) {
                        UI.showToast("Deletion Failed: Incorrect PIN.", 'danger', 'lock');
                        return;
                    }
                }
                
                const id = State.getCurrentStudentId();
                const student = State.appState.students.find(s => s.id === id);

                if (confirm(`Are you sure you want to permanently delete the profile for ${student.name}? This cannot be undone.`)) {
                    State.appState.students = State.appState.students.filter(s => s.id !== id);
                    State.appState.starHistory = State.appState.starHistory.filter(h => h.studentId !== id);
                    
                    State.saveState();
                    UI.showToast(`${student.name} deleted successfully.`, 'danger', 'trash-2');
                    UI.closeProfileModal(); 
                }
            }

            function handleStarAction(e) {
                e.preventDefault();

                const id = document.getElementById('star-action-student-id').value;
                const type = document.getElementById('star-action-type').value;
                const stars = parseInt(document.getElementById('star-amount').value);
                const reason = document.getElementById('star-reason').value.trim();

                if (isNaN(stars) || stars <= 0) {
                    UI.showToast("Error: Please enter a positive number of stars.", 'danger', 'x-circle');
                    return;
                }
                
                const student = State.appState.students.find(s => s.id === id);
                if (!student) return;

                if (type === 'add') {
                    student.stars += stars;
                    UI.triggerConfetti();
                    UI.showToast(`+${stars} Star${stars > 1 ? 's' : ''} awarded to ${student.name}!`, 'success', 'star');
                } else if (type === 'remove') {
                    if (student.stars < stars) {
                        UI.showToast(`Error: ${student.name} only has ${student.stars} stars.`, 'danger', 'alert-triangle');
                        return;
                    }
                    student.stars -= stars;
                    UI.showToast(`-${stars} Star${stars > 1 ? 's' : ''} removed from ${student.name}.`, 'danger', 'minus-circle');
                }

                // Log history
                State.appState.starHistory.push({
                    studentId: student.id,
                    type: type,
                    stars: stars,
                    date: UI.getTodayDateString(),
                    reason: reason || 'N/A'
                });
                
                Badge.checkAndAwardBadges(id); 

                State.saveState();
                UI.closeStarActionModal();
            }

            function handleStudentListClick(e) {
                const quickBtn = e.target.closest('.quick-action-btn');
                const card = e.target.closest('.student-card');

                if (quickBtn) {
                    e.stopPropagation(); 
                    const studentId = quickBtn.dataset.studentId;
                    
                    const student = State.appState.students.find(s => s.id === studentId);
                    if (student) {
                        student.stars += 1;
                        State.appState.starHistory.push({
                            studentId: student.id,
                            type: 'add',
                            stars: 1,
                            date: UI.getTodayDateString(),
                            reason: 'Quick star awarded'
                        });
                        
                        Badge.checkAndAwardBadges(studentId); 

                        State.saveState();
                        Render.renderStudentList();
                        Render.renderDashboardRecognition();
                        UI.showToast(`+1 Star awarded to ${student.name}.`, 'success', 'star');
                    }

                } else if (card) { 
                    UI.openProfileModal(card.dataset.studentId);
                }
            }


            function handleChangePassword(e) {
                e.preventDefault();
                const newPassword = document.getElementById('new-password').value;

                if (newPassword.length < 4) {
                    UI.showToast("PIN must be at least 4 digits long.", 'danger', 'alert-triangle');
                    return;
                }

                State.appState.teacherPassword = newPassword;
                State.saveState();
                document.getElementById('change-password-form').reset();
                UI.showToast("Login PIN updated successfully!", 'success', 'lock');
            }
            
            function handleRemovePassword() {
                if (confirm("Are you sure you want to remove the Teacher PIN? Access to Settings, Data Reset, and Student Deletion will become unrestricted.")) {
                    State.appState.teacherPassword = null;
                    State.saveState();
                    UI.showToast("Teacher PIN security removed.", 'warning', 'unlock');
                }
            }

            function handleFullReset() {
                if (State.appState.teacherPassword) {
                    const pin = prompt("Enter Teacher PIN to perform full reset:");
                    if (pin !== State.appState.teacherPassword) {
                        UI.showToast("Reset Failed: Incorrect PIN.", 'danger', 'lock');
                        return;
                    }
                }
                
                if (confirm("DANGER: Are you absolutely sure you want to perform a full app reset? ALL student data and history will be lost.")) {
                    
                    localStorage.removeItem(State.STATE_KEYS.STUDENTS);
                    localStorage.removeItem(State.STATE_KEYS.HISTORY);
                    localStorage.removeItem(State.STATE_KEYS.THEME);
                    localStorage.removeItem(State.STATE_KEYS.COLOR);
                    
                    StateModule.loadState();
                    State.saveState(); 

                    UI.showToast("Application data successfully reset (Demo loaded).", 'warning', 'loader');
                    UI.navigate('dashboard-view');
                    Render.renderAll();
                }
            }
            
            function handleExportData() {
                State.exportData();
                UI.showToast("Data exported as JSON file.", 'primary', 'download');
            }
            
            function handleImportData(e) {
                document.getElementById('import-file').click();
            }
            
            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const success = State.importData(event.target.result);
                    if (success) {
                        Badge.checkAllStudentsForBadges(); 
                        UI.showToast("Data imported successfully!", 'success', 'check-circle');
                        Render.renderAll();
                        UI.navigate('student-list-view');
                    } else {
                        UI.showToast("Import failed. Check file format.", 'danger', 'x-circle');
                    }
                };
                reader.onerror = () => {
                    UI.showToast("Error reading file.", 'danger', 'x-circle');
                };
                reader.readAsText(file);
            }


            // --- Initialization ---
            function attachListeners() {
                // Navigation & UI
                UI.getMobileMenuToggle().addEventListener('click', () => { UI.getSidebar().classList.toggle('active'); });
                document.querySelectorAll('.sidebar-menu .nav-item').forEach(item => {
                    item.addEventListener('click', (e) => { e.preventDefault(); UI.navigate(e.currentTarget.dataset.target); });
                });
                
                // Student List Interaction
                document.getElementById('student-list-container').addEventListener('click', handleStudentListClick);
                
                // Modals
                document.getElementById('close-profile-modal').addEventListener('click', UI.closeProfileModal);
                document.getElementById('close-edit-modal').addEventListener('click', UI.closeEditModal);
                document.getElementById('close-star-action-modal').addEventListener('click', UI.closeStarActionModal);
                
                // Student Profile Actions
                document.getElementById('delete-student-btn').addEventListener('click', handleDeleteStudent);
                document.getElementById('edit-student-btn').addEventListener('click', () => { UI.openEditModal(State.getCurrentStudentId()); });
                
                // Star Actions 
                document.querySelectorAll('.profile-actions .star-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.action === 'add-star' ? 'add' : 'remove';
                        UI.openStarActionModal(type, State.getCurrentStudentId());
                    });
                });
                document.getElementById('star-action-form').addEventListener('submit', handleStarAction);

                // Forms & Filters
                document.getElementById('add-student-form').addEventListener('submit', handleAddStudent);
                document.getElementById('edit-student-form').addEventListener('submit', handleEditStudent);
                document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);
                document.getElementById('remove-password-btn').addEventListener('click', handleRemovePassword);

                document.getElementById('student-search').addEventListener('input', Render.renderStudentList);
                document.getElementById('class-filter').addEventListener('change', Render.renderStudentList);
                document.getElementById('sort-filter').addEventListener('change', Render.renderStudentList);

                // Settings & Utility
                document.getElementById('full-reset-btn').addEventListener('click', handleFullReset);
                document.getElementById('dark-mode-toggle')?.addEventListener('click', () => {
                    State.appState.themeMode = State.appState.themeMode === 'dark' ? 'light' : 'dark';
                    State.saveState();
                    UI.updateThemeUI();
                    UI.showToast(`Switched to ${State.appState.themeMode.toUpperCase()} Mode.`, 'primary', State.appState.themeMode === 'dark' ? 'moon' : 'sun');
                });
                document.querySelectorAll('.theme-option').forEach(option => { 
                    option.addEventListener('click', (e) => {
                        State.appState.colorTheme = e.currentTarget.dataset.color;
                        State.saveState();
                        UI.updateThemeUI();
                        UI.showToast(`Theme color updated.`, 'primary', 'droplet');
                    }); 
                });
                
                // Import/Export
                document.getElementById('export-data-btn').addEventListener('click', handleExportData);
                document.getElementById('import-data-trigger').addEventListener('click', handleImportData);
                document.getElementById('import-file').addEventListener('change', handleFileSelect);
            }

            return {
                attachListeners
            };

        })(StateModule, UIModule, RenderModule, BadgeModule);


        // --- 6. App Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            StateModule.loadState();
            BadgeModule.checkAllStudentsForBadges(); 
            HandlersModule.attachListeners();
            UIModule.updateThemeUI();

            UIModule.navigate('dashboard-view');
            RenderModule.renderAll(); 
            feather.replace();
        });
    </script>
</body>
</html>
