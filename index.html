<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Students Manager - Final Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        /* --- CORE CSS DEFINITIONS --- */
        
        :root {
            /* Theme Base */
            --color-primary: #3b82f6; /* Blue */
            --color-success: #10b981; /* Green */
            --color-danger: #ef4444; /* Red */
            --color-star: #fbbf24; /* Yellow Star */
            --color-badge: #8b5cf6; /* Violet */
            
            /* Backgrounds */
            --bg-light: #f9fafb; /* Primary App Background */
            --bg-medium: #ffffff; /* Card/Sidebar Background */
            --bg-accent: #f3f4f6; /* Input/Hover Background */
            --text-dark: #111827;
            --text-muted: #6b7280;
            
            /* Dimensions */
            --border-radius-lg: 12px;
            --border-radius-sm: 8px;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition-duration: 0.3s;
            --sidebar-width: 240px;
            
            /* Avatar Colors */
            --avatar-color-male: #34d399; /* Emerald */
            --avatar-color-female: #fb7185; /* Rose */
        }
        
        /* Dark Mode Toggle */
        body[data-theme="dark"] {
            --bg-light: #1f2937; 
            --bg-medium: #374151; 
            --bg-accent: #4b5563;
            --text-dark: #f9fafb;
            --text-muted: #d1d5db;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* Dynamic Primary Color Change */
        body[data-color="purple"] { --color-primary: #a78bfa; }
        body[data-color="green"] { --color-primary: #10b981; }

        /* --- BASE STYLES & LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark); 
            transition: all var(--transition-duration); 
            min-height: 100vh; 
            display: flex; 
        }
        h1, h2, h3, h4 { color: var(--text-dark); margin-bottom: 10px; font-weight: 700; }
        .muted-text { color: var(--text-muted); font-size: 0.9rem; }
        
        /* CARD STYLES */
        .card, .form-card {
            background-color: var(--bg-medium);
            padding: 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-soft);
            transition: all var(--transition-duration);
        }
        .mt-20 { margin-top: 20px; }
        
        /* INPUT & BUTTON STYLES */
        .input-group { display: flex; align-items: center; margin-bottom: 15px; background-color: var(--bg-accent); border-radius: var(--border-radius-sm); padding: 0 10px; border: 1px solid transparent; }
        .input-group input, .input-group select, .input-group textarea { border: none; padding: 10px 0; background: transparent; color: var(--text-dark); flex-grow: 1; outline: none; }
        .btn { padding: 10px 20px; border-radius: var(--border-radius-sm); font-weight: 600; cursor: pointer; border: none; transition: background-color var(--transition-duration), transform 0.1s; display: inline-flex; align-items: center; gap: 8px; }
        .primary-btn { background-color: var(--color-primary); color: white; }
        .success-btn { background-color: var(--color-success); color: white; }
        .danger-btn { background-color: var(--color-danger); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- SIDEBAR & LAYOUT --- */
        #sidebar { width: var(--sidebar-width); background-color: var(--bg-medium); padding: 25px 15px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: var(--shadow-soft); flex-shrink: 0; z-index: 1000; }
        .sidebar-menu a { display: flex; align-items: center; gap: 15px; padding: 12px 10px; margin-bottom: 8px; text-decoration: none; color: var(--text-dark); border-radius: var(--border-radius-sm); transition: all 0.2s; font-weight: 500; }
        .sidebar-menu a.active { background-color: var(--color-primary); color: white; font-weight: 600; }
        #content-wrapper { flex-grow: 1; min-height: 100vh; padding: 25px 35px; width: calc(100% - var(--sidebar-width)); }
        .app-view { max-width: 1200px; margin: 0 auto; display: none; }
        .app-view.active { display: block; }
        
        /* STUDENT LIST STYLES */
        .student-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .student-card { 
            display: flex; align-items: center; gap: 15px; cursor: pointer; position: relative; padding: 15px; 
            border-left: 5px solid var(--color-primary); /* Visual accent */
        }
        .student-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        
        /* Avatar */
        .student-card .avatar, .mini-avatar, .profile-avatar { border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; flex-shrink: 0; }
        .student-card .avatar { width: 60px; height: 60px; font-size: 1.8rem; }
        .profile-avatar { width: 110px; height: 110px; font-size: 3rem; border: 6px solid var(--color-star); margin: 0 auto; }
        
        /* Quick Action */
        .quick-action-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); padding: 6px 10px; font-size: 0.9rem; }
        .stars { margin-left: auto; display: flex; align-items: center; gap: 5px; font-size: 1.2rem; font-weight: 700; color: var(--color-star); }

        /* --- MODAL STYLES --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 50px; }
        .modal.active { display: block; }
        .modal-content { background-color: var(--bg-medium); margin: auto; padding: 30px; border-radius: var(--border-radius-lg); width: 90%; max-width: 500px; position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease-out; }
        #profile-modal .modal-content { max-width: 600px; text-align: center; }
        .close-btn { position: absolute; top: 15px; right: 15px; color: var(--text-muted); font-size: 1.5rem; font-weight: bold; cursor: pointer; background: none; border: none; }
        
        /* Profile specific styles */
        .profile-stars { font-size: 1.5rem; font-weight: 700; color: var(--color-star); margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .badge-display-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        .badge-item { padding: 8px 12px; background-color: var(--bg-accent); border-radius: var(--border-radius-sm); color: var(--color-badge); font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 5px; border: 1px solid var(--color-badge); }
        
        /* History Timeline */
        .history-timeline { max-height: 250px; overflow-y: auto; text-align: left; margin-top: 15px; }
        .history-item { padding: 10px 0; border-left: 3px solid var(--bg-accent); position: relative; padding-left: 20px; margin-left: 10px; }
        .history-item:before { content: ''; position: absolute; left: -7px; top: 12px; width: 14px; height: 14px; border-radius: 50%; background-color: var(--bg-medium); border: 3px solid; }
        .history-item.add:before { border-color: var(--color-success); }
        .history-item.remove:before { border-color: var(--color-danger); }
        .history-item-details { display: block; font-size: 0.9rem; }
        .history-item-details strong { font-size: 1rem; }
    </style>
</head>
<body data-theme="light" data-color="blue">
    
    <nav id="sidebar">
        <div>
            <div class="sidebar-header">
                <h3>Star Zone ‚ú®</h3>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" data-target="dashboard-view" class="nav-item active"><i data-feather="grid"></i> Dashboard</a></li>
                <li><a href="#" data-target="student-list-view" class="nav-item"><i data-feather="users"></i> Student Roster</a></li>
                <li><a href="#" data-target="badges-view" class="nav-item"><i data-feather="award"></i> Badges & Rewards</a></li> 
                <li><a href="#" data-target="add-student-view" class="nav-item"><i data-feather="user-plus"></i> Enroll Student</a></li>
                <li><a href="#" data-target="settings-view" class="nav-item"><i data-feather="settings"></i> Settings</a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <button id="dark-mode-toggle" class="btn primary-btn" title="Toggle Dark Mode" style="width: 100%;"><i data-feather="moon"></i> Dark Mode</button>
            <p class="muted-text" style="font-size: 0.75rem; text-align: center; margin-top: 10px;">v2.0 - Final Core Release</p>
        </div>
    </nav>

    <div id="content-wrapper">
        <button id="mobile-menu-toggle" class="btn primary-btn mobile-only"><i data-feather="menu"></i></button>

        <div id="dashboard-view" class="app-view active">
            <h2>Welcome to the Star Zone!</h2>
            <div class="card" style="padding: 15px; border-left: 5px solid var(--color-primary); margin-top: 15px;">
                <h3 id="daily-quote" style="font-size: 1rem; margin: 0;">Loading quote...</h3>
                <p id="quote-author" class="muted-text" style="text-align: right; margin-top: 5px; font-style: italic;"></p>
            </div>
            <h2 class="mt-20">Star Achievers</h2>
            <div class="recognition-grid">
                <p class="muted-text">Top students will appear here.</p>
                </div>
        </div>

        <div id="student-list-view" class="app-view">
            <h2>Student Roster</h2>
            <div class="list-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="input-group search-group" style="flex-grow: 1;">
                    <i data-feather="search"></i>
                    <input type="text" id="student-search" placeholder="Search by name...">
                </div>
                <div class="input-group">
                    <select id="class-filter">
                        <option value="all">All Classes</option>
                    </select>
                </div>
                <div class="input-group">
                    <select id="sort-filter">
                        <option value="stars-desc">‚≠ê Stars (High)</option>
                        <option value="name-asc">A-Z Name</option>
                        <option value="roll-asc">Roll No.</option>
                    </select>
                </div>
            </div>
            <div id="student-list-container" class="student-list-grid">
                <p id="no-students-message" class="empty-message">No students found. Use the 'Enroll Student' tab to add one!</p>
            </div>
        </div>
        
        <div id="badges-view" class="app-view">
            <h2>Achievement Badges üèÖ</h2>
            <p class="muted-text">Unlock these rewards by completing different star milestones and actions.</p>
            <div id="all-badges-container" class="recognition-grid mt-20">
                 <p class="muted-text">Badges are listed here.</p>
                </div>
        </div>


        <div id="add-student-view" class="app-view">
            <h2>Enroll New Student</h2>
            <form id="add-student-form" class="form-card" style="max-width: 500px;">
                <div class="input-group"><i data-feather="user"></i><input type="text" id="add-name" placeholder="Full Name" required></div>
                <div class="input-group">
                    <i data-feather="user-check"></i>
                    <select id="add-gender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group"><i data-feather="bookmark"></i><input type="text" id="add-class" placeholder="Class (e.g., 5A)" required></div>
                <div class="input-group"><i data-feather="hash"></i><input type="number" id="add-roll" placeholder="Roll Number" required></div>
                <div class="input-group"><i data-feather="calendar"></i><input type="date" id="add-dob" placeholder="Date of Birth (Optional)"></div>
                <div class="input-group"><i data-feather="star"></i><input type="number" id="add-stars" placeholder="Initial Stars (e.g., 0)" value="0"></div>
                <button type="submit" class="btn primary-btn" style="width: 100%;"><i data-feather="user-plus"></i> Enroll Student</button>
            </form>
        </div>


        <div id="settings-view" class="app-view">
            <h2>Settings ‚öôÔ∏è</h2>
            <div class="settings-group">
                <h3>Security</h3>
                <form id="change-password-form" class="form-card" style="max-width: 500px;">
                    <p class="muted-text">Set/Change a 4-digit Teacher PIN (Optional). Required for star actions.</p>
                    <div class="input-group"><i data-feather="lock"></i><input type="password" id="new-password" placeholder="New PIN (4+ digits)" required></div>
                    <button type="submit" class="btn primary-btn">Update PIN</button>
                    <button type="button" id="remove-password-btn" class="btn danger-btn" style="margin-top: 10px;"><i data-feather="slash"></i> Remove PIN Security</button>
                </form>
            </div>

            <div class="settings-group mt-20">
                <h3>Theme & Data</h3>
                <div class="form-card" style="max-width: 500px;">
                    <p class="muted-text">Select Primary Color:</p>
                    <div class="theme-picker" style="display: flex; gap: 15px; margin-top: 10px;">
                        <div class="theme-option theme-blue active" data-color="blue" title="Blue Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #3b82f6;"></div>
                        <div class="theme-option theme-purple" data-color="purple" title="Purple Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #a78bfa;"></div>
                        <div class="theme-option theme-green" data-color="green" title="Green Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #10b981;"></div>
                    </div>
                    <button id="export-data-btn" class="btn primary-btn" style="margin-top: 20px;"><i data-feather="download"></i> Export Data</button>
                    <input type="file" id="import-file" accept="application/json" style="display: none;">
                    <button id="import-data-trigger" class="btn primary-btn" style="margin-top: 10px; margin-left: 10px;"><i data-feather="upload"></i> Import Data</button>
                </div>
            </div>
            
            <div class="settings-group danger-zone mt-20">
                <h3>Danger Zone</h3>
                <div class="form-card" style="border: 1px dashed var(--color-danger); max-width: 500px;">
                    <p class="muted-text">Permanently delete all students, history, and notes.</p>
                    <button id="full-reset-btn" class="btn danger-btn" style="width: 100%; margin-top: 15px;"><i data-feather="trash-2"></i> Full App Data Reset</button>
                </div>
            </div>
        </div>

    </div> <div id="profile-modal" class="modal">
        <div class="modal-content profile-content">
            <button class="close-btn" id="close-profile-modal"><i data-feather="x"></i></button>
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar"></div>
                <h2 id="profile-name">Student Name</h2>
                <p class="muted-text"><span id="profile-class"></span>, Roll: <span id="profile-roll"></span></p>
                <p class="muted-text" id="profile-dob">DOB: N/A</p>
            </div>
            
            <div class="profile-stars">
                <i data-feather="star" class="star-icon" fill="var(--color-star)" style="width: 30px; height: 30px;"></i>
                Total Stars: <span id="profile-star-count">0</span>
            </div>
            
            <div class="profile-section card" style="margin-top: 20px;">
                <h3 style="display: flex; align-items: center; justify-content: center; gap: 8px;"><i data-feather="award" style="stroke: var(--color-badge);"></i> Earned Badges (<span id="profile-badge-count">0</span>)</h3>
                <div id="student-badges-container" class="badge-display-grid">
                    <p id="no-badges-message" class="muted-text" style="width: 100%; text-align: center;">No achievements unlocked yet.</p>
                </div>
            </div>

            <div class="profile-actions card" style="margin-top: 20px; border: 1px solid var(--bg-accent);">
                <h3>Star Actions</h3>
                <div class="action-group" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn success-btn star-btn" data-action="add-star" style="flex: 1;"><i data-feather="plus"></i> Add Stars</button>
                    <button class="btn danger-btn star-btn" data-action="remove-star" style="flex: 1;"><i data-feather="minus"></i> Remove Stars</button>
                </div>
            </div>

            <div class="profile-section" style="margin-top: 20px;">
                <button id="edit-student-btn" class="btn primary-btn" style="width: 100%;"><i data-feather="edit-3"></i> Edit Student Details</button>
            </div>

            <div class="profile-section" style="margin-top: 20px;">
                <h3><i data-feather="clock"></i> Star History Timeline</h3>
                <div id="star-history-timeline" class="history-timeline"></div>
            </div>
            
            <button id="delete-student-btn" class="btn danger-btn mt-20" style="width: 100%;"><i data-feather="trash-2"></i> Delete Student</button>
        </div>
    </div>

    <div id="star-action-modal" class="modal">
        <div class="modal-content star-action-content">
            <button class="close-btn" id="close-star-action-modal"><i data-feather="x"></i></button>
            <h2 id="star-action-title">Star Action</h2>
            <form id="star-action-form">
                <input type="hidden" id="star-action-type">
                <input type="hidden" id="star-action-student-id">
                
                <div class="input-group">
                    <i data-feather="star"></i>
                    <input type="number" id="star-amount" placeholder="Number of Stars (1+)" min="1" required>
                </div>
                
                <textarea id="star-reason" placeholder="Reason/Comment (e.g., 'Excellent presentation')" style="min-height: 80px; width: 100%; margin-bottom: 15px; padding: 10px; border-radius: var(--border-radius-sm); border: 1px solid var(--bg-accent); background-color: var(--bg-accent);"></textarea>
                
                <p id="star-action-info" class="muted-text"></p>
                
                <button type="submit" id="star-submit-btn" class="btn primary-btn mt-15" style="width: 100%;">
                    <i data-feather="check"></i> Confirm Action
                </button>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" id="close-edit-modal"><i data-feather="x"></i></button>
            <h2>Edit Student Details</h2>
            <form id="edit-student-form" class="form-card">
                <input type="hidden" id="edit-id">
                <div class="input-group"><i data-feather="user"></i><input type="text" id="edit-name" placeholder="Name" required></div>
                <div class="input-group">
                    <i data-feather="user-check"></i>
                    <select id="edit-gender" required style="flex-grow: 1;">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group"><i data-feather="bookmark"></i><input type="text" id="edit-class" placeholder="Class (e.g., 5B)" required></div>
                <div class="input-group"><i data-feather="hash"></i><input type="number" id="edit-roll" placeholder="Roll Number" required></div>
                <div class="input-group"><i data-feather="calendar"></i><input type="date" id="edit-dob" title="Date of Birth"></div>
                <button type="submit" class="btn primary-btn" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>
    
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 3000;">
        <style>
            .toast {
                background-color: var(--color-primary);
                color: white;
                padding: 12px 20px;
                border-radius: var(--border-radius-sm);
                box-shadow: var(--shadow-soft);
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 10px;
                opacity: 0;
                transform: translateX(100%);
                transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            }
            .toast.show {
                opacity: 1;
                transform: translateX(0);
            }
            .toast.success { background-color: var(--color-success); }
            .toast.danger { background-color: var(--color-danger); }
            .toast.badge-awarded { background-color: var(--color-badge); }
        </style>
    </div>
    
    <script>
        
        // --- DATA RESOURCES ---
        const DAILY_QUOTES = [
            { quote: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
            { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { quote: "Be the change that you wish to see in the world.", author: "Mahatma Gandhi" },
        ];
        
        const CHARACTERS = {
            MALE_ICON: '&#128102;', // üë¶
            FEMALE_ICON: '&#128103;', // üëß
            MALE_COLOR: 'var(--avatar-color-male)', 
            FEMALE_COLOR: 'var(--avatar-color-female)',
            
            getAvatar: (gender) => gender === 'female' ? CHARACTERS.FEMALE_ICON : CHARACTERS.MALE_ICON,
            getColor: (gender) => gender === 'female' ? CHARACTERS.FEMALE_COLOR : CHARACTERS.MALE_COLOR
        };

        const BADGES_LIST = [
            { id: 'first_star', name: 'First Star', description: 'Awarded after receiving the very first star.', icon: 'award', type: 'star_count', count: 1 },
            { id: 'star_centurion', name: 'Star Centurion', description: 'Reached 100 total stars.', icon: 'shield', type: 'star_count', count: 100 },
            { id: 'star_veteran', name: 'Star Veteran', description: 'Reached 500 total stars.', icon: 'zap', type: 'star_count', count: 500 },
        ];
        
        // --- 1. State Module ---
        const StateModule = (function() {
            // Updated version key after removing purchase history
            const STATE_KEYS = {
                STUDENTS: 'starManager_students_v9', 
                HISTORY: 'starManager_starHistory_v9',
                PASSWORD: 'starManager_teacherPassword_v2', 
                THEME: 'starManager_themeMode_v2',
                COLOR: 'starManager_colorTheme_v2',
                LAST_QUOTE_INDEX: 'starManager_lastQuoteIndex_v1',
                LAST_QUOTE_DATE: 'starManager_lastQuoteDate_v1',
            };

            const DEMO_STUDENTS = [
                { id: 's1', name: 'Maya Sharma', class: '5A', roll: 12, stars: 300, dob: '2015-05-15', gender: 'female', avatar: CHARACTERS.getAvatar('female'), badges: ['first_star', 'star_centurion'] }, 
                { id: 's2', name: 'Rohan Singh', class: '5A', roll: 9, stars: 150, dob: '2016-01-20', gender: 'male', avatar: CHARACTERS.getAvatar('male'), badges: ['first_star'] }, 
                { id: 's3', name: 'Priya Verma', class: '6B', roll: 4, stars: 20, dob: '2015-11-01', gender: 'female', avatar: CHARACTERS.getAvatar('female'), badges: [] },
            ];
            
            const getDemoHistory = () => {
                return [
                    { studentId: 's1', type: 'add', stars: 10, date: new Date(Date.now() - 86400000).toISOString(), reason: 'Good participation' },
                    { studentId: 's2', type: 'add', stars: 5, date: new Date().toISOString(), reason: 'Helping a classmate' },
                ];
            };

            let appState = {
                students: [],
                starHistory: [],
                teacherPassword: null, 
                themeMode: 'light', 
                colorTheme: 'blue',
                quote: DAILY_QUOTES[0], 
            };
            
            let currentModalStudentId = null;

            function saveState() {
                try {
                    localStorage.setItem(STATE_KEYS.STUDENTS, JSON.stringify(appState.students));
                    localStorage.setItem(STATE_KEYS.HISTORY, JSON.stringify(appState.starHistory));
                    localStorage.setItem(STATE_KEYS.PASSWORD, appState.teacherPassword || '');
                    localStorage.setItem(STATE_KEYS.THEME, appState.themeMode);
                    localStorage.setItem(STATE_KEYS.COLOR, appState.colorTheme);
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                }
            }

            function getDailyQuote() { 
                const today = new Date().toDateString();
                let lastDate = localStorage.getItem(STATE_KEYS.LAST_QUOTE_DATE);
                let lastIndex = parseInt(localStorage.getItem(STATE_KEYS.LAST_QUOTE_INDEX) || 0);

                if (today !== lastDate) {
                    lastIndex = (lastIndex + 1) % DAILY_QUOTES.length;
                    localStorage.setItem(STATE_KEYS.LAST_QUOTE_DATE, today);
                    localStorage.setItem(STATE_KEYS.LAST_QUOTE_INDEX, lastIndex);
                }
                appState.quote = DAILY_QUOTES[lastIndex];
            }

            function loadState() {
                try {
                    appState.teacherPassword = localStorage.getItem(STATE_KEYS.PASSWORD) || null;
                    
                    const storedStudents = JSON.parse(localStorage.getItem(STATE_KEYS.STUDENTS));
                    const storedHistory = JSON.parse(localStorage.getItem(STATE_KEYS.HISTORY));

                    if (storedStudents && storedStudents.length > 0) {
                        appState.students = storedStudents.map(s => ({
                            ...s, 
                            badges: s.badges || [],
                            gender: s.gender || 'male', 
                            avatar: s.avatar || CHARACTERS.getAvatar(s.gender || 'male'),
                        })); 
                        appState.starHistory = storedHistory || [];
                    } else {
                        appState.students = DEMO_STUDENTS;
                        appState.starHistory = getDemoHistory();
                    }
                    getDailyQuote(); 
                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                    appState.students = DEMO_STUDENTS;
                    appState.starHistory = getDemoHistory();
                }
            }
            
            return {
                appState,
                saveState,
                loadState,
                getStudentById: (id) => appState.students.find(s => s.id === id),
                getCurrentStudentId: () => currentModalStudentId,
                setCurrentStudentId: (id) => { currentModalStudentId = id; },
            };
        })();


        // --- 2. Badge Module ---
        const BadgeModule = (function(State) {
            
            function checkStarCountBadge(student, badge) { return student.stars >= badge.count; }

            function checkAndAwardBadges(studentId) {
                const student = State.getStudentById(studentId);
                if (!student) return false;

                let awarded = false;
                
                BADGES_LIST.forEach(badge => {
                    if (student.badges.includes(badge.id)) return;

                    let criteriaMet = false;
                    if (badge.type === 'star_count') criteriaMet = checkStarCountBadge(student, badge);

                    if (criteriaMet) {
                        student.badges.push(badge.id);
                        window.UIModule.showToast(`New Badge Unlocked: ${badge.name}`, 'badge-awarded', badge.icon);
                        awarded = true;
                    }
                });

                if (awarded) State.saveState();
                return awarded;
            }
            
            function checkAllStudentsForBadges() {
                State.appState.students.forEach(s => checkAndAwardBadges(s.id));
            }

            return { checkAndAwardBadges, checkAllStudentsForBadges, BADGES_LIST };
        })(StateModule);

        
        // --- 3. UI Module ---
        const UIModule = (function(State, Badge) {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            
            function uuid() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }
            function getTodayDateString() { return new Date().toISOString(); }
            
            function showToast(message, type = 'primary', icon = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i data-feather="${icon}"></i> ${message}`;
                
                container.appendChild(toast);
                feather.replace();

                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            function navigate(targetViewId) {
                document.querySelectorAll('.app-view').forEach(view => view.classList.remove('active'));
                
                const targetView = document.getElementById(targetViewId);
                if (targetView) {
                    targetView.classList.add('active');
                    
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    document.querySelector(`.nav-item[data-target="${targetViewId}"]`)?.classList.add('active');
                    
                    if (sidebar.classList.contains('active') && window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                    }
                    
                    if (window.RenderModule) {
                        if (targetViewId === 'dashboard-view') window.RenderModule.renderDashboardRecognition();
                        if (targetViewId === 'student-list-view') window.RenderModule.renderStudentList(); 
                        if (targetViewId === 'badges-view') window.RenderModule.renderBadgesView(); 
                    }
                }
            }
            
            function openModal(modalId) {
                document.querySelectorAll('.modal').forEach(m => {
                    if (m.id !== modalId) m.classList.remove('active');
                });

                document.getElementById(modalId).classList.add('active');
                document.body.style.overflow = 'hidden'; 
                feather.replace();
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                if (document.querySelectorAll('.modal.active').length === 0) {
                     document.body.style.overflow = '';
                }
            }
            
            function openProfileModal(studentId) {
                const student = State.getStudentById(studentId);
                if (!student) return;

                State.setCurrentStudentId(studentId);
                document.getElementById('profile-name').textContent = student.name;
                document.getElementById('profile-class').textContent = student.class;
                document.getElementById('profile-roll').textContent = student.roll;
                document.getElementById('profile-dob').textContent = `DOB: ${student.dob || 'N/A'}`;
                document.getElementById('profile-star-count').textContent = student.stars;
                
                const avatarEl = document.getElementById('profile-avatar');
                avatarEl.innerHTML = CHARACTERS.getAvatar(student.gender);
                avatarEl.style.backgroundColor = CHARACTERS.getColor(student.gender);

                // History
                const historyContainer = document.getElementById('star-history-timeline');
                const studentHistory = State.appState.starHistory
                    .filter(h => h.studentId === studentId)
                    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

                historyContainer.innerHTML = studentHistory.map(h => {
                    const typeClass = h.type === 'add' ? 'add' : 'remove';
                    const sign = h.type === 'add' ? '+' : '-';
                    const dateFormatted = new Date(h.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    
                    return `
                        <div class="history-item ${typeClass}">
                            <span class="history-item-details">
                                <strong>${sign}${h.stars} Stars</strong> 
                                <span class="muted-text">(${h.reason || 'No reason specified'})</span>
                                <span class="muted-text" style="float: right;">${dateFormatted}</span>
                            </span>
                        </div>
                    `;
                }).join('');
                if (studentHistory.length === 0) historyContainer.innerHTML = `<p class="muted-text" style="text-align: center;">No star history yet.</p>`;


                // Badges
                const badgeContainer = document.getElementById('student-badges-container');
                const noBadgesMessage = document.getElementById('no-badges-message');
                const badgeCountEl = document.getElementById('profile-badge-count');

                if (student.badges.length > 0) {
                    noBadgesMessage.style.display = 'none';
                    badgeContainer.innerHTML = student.badges.map(badgeId => {
                        const badge = Badge.BADGES_LIST.find(b => b.id === badgeId);
                        return badge ? `<div class="badge-item" title="${badge.description}"><i data-feather="${badge.icon}" style="fill: currentColor; width: 14px; height: 14px;"></i>${badge.name}</div>` : '';
                    }).join('');
                } else {
                    noBadgesMessage.style.display = 'block';
                    badgeContainer.innerHTML = '';
                }
                badgeCountEl.textContent = student.badges.length;

                openModal('profile-modal');
            }
            
            function openEditModal(studentId) {
                const student = State.getStudentById(studentId);
                if (!student) return;

                document.getElementById('edit-id').value = student.id;
                document.getElementById('edit-name').value = student.name;
                document.getElementById('edit-class').value = student.class;
                document.getElementById('edit-roll').value = student.roll;
                document.getElementById('edit-dob').value = student.dob || '';
                document.getElementById('edit-gender').value = student.gender;
                
                openModal('edit-modal');
            }

            function openStarActionModal(type, studentId) {
                const student = State.getStudentById(studentId);
                if (!student) return;
                
                const isAdd = type === 'add';
                document.getElementById('star-action-type').value = type;
                document.getElementById('star-action-student-id').value = studentId;
                document.getElementById('star-action-title').textContent = isAdd ? `Award Stars to ${student.name}` : `Remove Stars from ${student.name}`;
                document.getElementById('star-submit-btn').className = `btn ${isAdd ? 'success-btn' : 'danger-btn'} mt-15`;
                document.getElementById('star-action-info').textContent = isAdd 
                    ? `Reason for giving stars (e.g., homework completion).` 
                    : `Reason for deduction (Max: ${student.stars} stars).`;
                document.getElementById('star-amount').max = isAdd ? 9999 : student.stars;
                document.getElementById('star-amount').value = isAdd ? 1 : 1;
                document.getElementById('star-reason').value = '';
                
                openModal('star-action-modal');
            }
            
            function updateThemeUI() {
                const body = document.body;
                body.setAttribute('data-theme', State.appState.themeMode);
                body.setAttribute('data-color', State.appState.colorTheme);

                const toggleIcon = State.appState.themeMode === 'dark' ? 'sun' : 'moon';
                const toggleButton = document.getElementById('dark-mode-toggle');
                if (toggleButton) {
                    toggleButton.innerHTML = `<i data-feather="${toggleIcon}"></i> ${State.appState.themeMode === 'dark' ? 'Light Mode' : 'Dark Mode'}`;
                    feather.replace();
                }
                
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.style.borderColor = 'transparent';
                    if (option.dataset.color === State.appState.colorTheme) {
                        option.style.borderColor = State.appState.themeMode === 'dark' ? 'white' : 'var(--text-dark)'; 
                    }
                });
            }

            return {
                navigate,
                showToast,
                uuid,
                getTodayDateString,
                openProfileModal,
                // Helper functions to close Modals and re-render
                closeProfileModal: () => { closeModal('profile-modal'); window.RenderModule.renderAll(); State.setCurrentStudentId(null); },
                closeEditModal: () => { closeModal('edit-modal'); const currentId = State.getCurrentStudentId(); if(currentId) UIModule.openProfileModal(currentId); window.RenderModule.renderAll(); },
                closeStarActionModal: () => { closeModal('star-action-modal'); const currentId = State.getCurrentStudentId(); if (currentId) UIModule.openProfileModal(currentId); window.RenderModule.renderAll(); },
                openStarActionModal, 
                openEditModal,
                updateThemeUI,
                getSidebar: () => sidebar,
                getMobileMenuToggle: () => mobileMenuToggle,
            };

        })(StateModule, BadgeModule);

        window.UIModule = UIModule; 

        // --- 4. Render Module ---
        const RenderModule = (function(State, UI, Badge) {

            // --- Sub-Renders ---
            function renderStudentCard(student) {
                 return `
                    <div class="student-card card" data-student-id="${student.id}">
                        <div class="avatar" style="background-color: ${CHARACTERS.getColor(student.gender)};">${CHARACTERS.getAvatar(student.gender)}</div>
                        <div class="info">
                            <h4>${student.name}</h4>
                            <p>Class: ${student.class} | Roll: ${student.roll}</p>
                            ${student.badges.length > 0 ? `<p style="color: var(--color-badge); font-weight: 600; font-size: 0.8rem; margin-top: 2px;">üèÖ ${student.badges.length} Badges</p>` : ''}
                        </div>
                        <div class="stars">
                            <i data-feather="star" fill="currentColor" style="width: 18px; height: 18px;"></i>
                            ${student.stars}
                        </div>
                        <button class="quick-action-btn btn success-btn" data-student-id="${student.id}" data-action="quick-star" title="Quick Add Star">
                            <i data-feather="plus" style="width: 14px; height: 14px;"></i><span>1</span>
                        </button>
                    </div>
                `;
            }

            function renderStudentList() {
                const container = document.getElementById('student-list-container');
                const noStudentsMessage = document.getElementById('no-students-message');
                
                // Get current filter and search values
                const search = document.getElementById('student-search').value.toLowerCase();
                const classFilter = document.getElementById('class-filter').value;
                const sortFilter = document.getElementById('sort-filter').value;

                // 1. Filtering
                let filteredStudents = State.appState.students.filter(s => {
                    const matchesSearch = s.name.toLowerCase().includes(search) || s.class.toLowerCase().includes(search);
                    const matchesClass = classFilter === 'all' || s.class === classFilter;
                    return matchesSearch && matchesClass;
                });
                
                // 2. Sorting
                filteredStudents.sort((a, b) => {
                    if (sortFilter === 'stars-desc') return b.stars - a.stars;
                    if (sortFilter === 'name-asc') return a.name.localeCompare(b.name);
                    if (sortFilter === 'roll-asc') return a.roll - b.roll;
                    return 0;
                });

                // 3. Render List
                container.innerHTML = filteredStudents.map(renderStudentCard).join('');
                noStudentsMessage.style.display = filteredStudents.length === 0 ? 'block' : 'none';
                feather.replace();
                
                // 4. Update Class Filter Options
                const classes = [...new Set(State.appState.students.map(s => s.class))].sort();
                const classSelect = document.getElementById('class-filter');
                const currentClass = classSelect.value; 
                classSelect.innerHTML = '<option value="all">All Classes</option>' + 
                    classes.map(c => `<option value="${c}" ${c === currentClass ? 'selected' : ''}>${c}</option>`).join('');
            }
            
            function renderBadgesView() {
                const container = document.getElementById('all-badges-container');
                container.innerHTML = Badge.BADGES_LIST.map(badge => {
                    return `
                        <div class="card" style="display: flex; gap: 15px; align-items: center; border-left: 5px solid var(--color-badge);">
                            <i data-feather="${badge.icon}" style="stroke: var(--color-badge); width: 30px; height: 30px;"></i>
                            <div>
                                <h4>${badge.name}</h4>
                                <p class="muted-text">${badge.description}</p>
                                <p class="muted-text" style="font-size: 0.8rem; font-weight: 600;">Criteria: ${badge.count} Stars</p>
                            </div>
                        </div>
                    `;
                }).join('');
                feather.replace();
            }
            
            function renderDashboardRecognition() {
                 document.getElementById('daily-quote').textContent = `"${State.appState.quote.quote}"`;
                 document.getElementById('quote-author').textContent = `- ${State.appState.quote.author}`;
                 
                 const recognitionContainer = document.querySelector('.recognition-grid');
                 const topStudents = State.appState.students.slice().sort((a, b) => b.stars - a.stars).slice(0, 3);

                 if (topStudents.length > 0) {
                    recognitionContainer.innerHTML = topStudents.map((s, index) => {
                        return `
                            <div class="card" style="padding: 15px; border-left: 5px solid ${index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze'}; margin-top: 10px; display: flex; align-items: center; gap: 15px;">
                                <h2 style="margin: 0; color: var(--color-star);">${index + 1}.</h2>
                                <div class="avatar mini-avatar" style="background-color: ${CHARACTERS.getColor(s.gender)}; width: 40px; height: 40px; font-size: 1.2rem;">${CHARACTERS.getAvatar(s.gender)}</div>
                                <div>
                                    <h4 style="margin: 0;">${s.name}</h4>
                                    <p class="muted-text">${s.class}</p>
                                </div>
                                <div class="stars" style="margin-left: auto; font-size: 1.3rem;">${s.stars}</div>
                            </div>
                        `;
                    }).join('');
                 } else {
                     recognitionContainer.innerHTML = '<p class="muted-text" style="text-align: center;">No students to display on the dashboard yet.</p>';
                 }
                 
                 feather.replace();
            }

            function renderAll() {
                renderStudentList();
                renderDashboardRecognition();
                renderBadgesView(); 
                UI.updateThemeUI();
            }

            return {
                renderStudentList,
                renderDashboardRecognition,
                renderBadgesView,
                renderAll,
            };

        })(StateModule, UIModule, BadgeModule);
        
        window.RenderModule = RenderModule; 

        // --- 5. Handlers Module ---
        const HandlersModule = (function(State, UI, Render, Badge) {
            
            function handleAddStudent(e) {
                e.preventDefault();
                const name = document.getElementById('add-name').value;
                const classVal = document.getElementById('add-class').value;
                const roll = parseInt(document.getElementById('add-roll').value);
                const gender = document.getElementById('add-gender').value;
                const dob = document.getElementById('add-dob').value;
                const initialStars = parseInt(document.getElementById('add-stars').value) || 0;

                const newStudent = {
                    id: UI.uuid(),
                    name, class: classVal, roll, gender, dob,
                    stars: initialStars,
                    badges: [],
                    avatar: CHARACTERS.getAvatar(gender),
                };

                State.appState.students.push(newStudent);
                State.saveState();
                document.getElementById('add-student-form').reset();
                UI.showToast(`${name} enrolled successfully!`, 'success', 'user-check');
                Render.renderAll();
                UI.navigate('student-list-view');
            }

            function handleEditStudent(e) {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;
                const student = State.getStudentById(id);

                student.name = document.getElementById('edit-name').value;
                student.class = document.getElementById('edit-class').value;
                student.roll = parseInt(document.getElementById('edit-roll').value);
                student.dob = document.getElementById('edit-dob').value;
                student.gender = document.getElementById('edit-gender').value;
                student.avatar = CHARACTERS.getAvatar(student.gender); 

                State.saveState();
                UI.showToast(`${student.name} details updated.`, 'primary', 'edit');
                UI.closeEditModal(); 
            }
            
            function handleDeleteStudent() {
                const id = State.getCurrentStudentId();
                const student = State.getStudentById(id);
                if (!student) return;

                if (!confirm(`Are you sure you want to permanently delete ${student.name}? This cannot be undone.`)) return;

                State.appState.students = State.appState.students.filter(s => s.id !== id);
                State.appState.starHistory = State.appState.starHistory.filter(h => h.studentId !== id); 

                State.saveState();
                UI.showToast(`${student.name} was successfully deleted.`, 'danger', 'trash-2');
                UI.closeProfileModal(); 
            }

            function handleStudentListClick(e) {
                const card = e.target.closest('.student-card');
                const quickAction = e.target.closest('.quick-action-btn');
                
                if (card) {
                    const studentId = card.dataset.studentId;
                    if (quickAction) {
                        // Quick Add Star
                        UI.openStarActionModal('add', studentId);
                    } else {
                        // Open Profile
                        UI.openProfileModal(studentId);
                    }
                }
            }
            
            function handleStarAction(e) {
                e.preventDefault();

                const id = document.getElementById('star-action-student-id').value;
                const type = document.getElementById('star-action-type').value;
                const stars = parseInt(document.getElementById('star-amount').value);
                const reason = document.getElementById('star-reason').value.trim();
                const student = State.getStudentById(id);

                if (isNaN(stars) || stars <= 0) {
                    UI.showToast("Star amount must be 1 or more.", 'danger', 'alert-triangle');
                    return;
                }
                
                // PIN Check
                if (State.appState.teacherPassword) {
                    const pin = prompt("Enter Teacher PIN to confirm star action:");
                    if (pin !== State.appState.teacherPassword) {
                        UI.showToast("Action Denied: Incorrect PIN.", 'danger', 'lock');
                        return;
                    }
                }
                
                // Star Update Logic
                if (type === 'add') {
                    student.stars += stars;
                    UI.showToast(`+${stars} Star${stars > 1 ? 's' : ''} awarded to ${student.name}!`, 'success', 'star');
                } else if (type === 'remove') {
                    if (student.stars < stars) {
                        UI.showToast(`Error: ${student.name} only has ${student.stars} stars.`, 'danger', 'alert-triangle');
                        return;
                    }
                    student.stars -= stars;
                    UI.showToast(`-${stars} Star${stars > 1 ? 's' : ''} removed from ${student.name}.`, 'danger', 'minus-circle');
                }
                
                // History & Badge Check
                State.appState.starHistory.push({ studentId: student.id, type: type, stars: stars, date: UI.getTodayDateString(), reason: reason || 'N/A' });
                Badge.checkAndAwardBadges(id); 
                State.saveState();
                UI.closeStarActionModal();
            }

            // ... (Other handlers like PIN, Import/Export, Reset) ...
            
            function attachListeners() {
                // Navigation & UI
                UI.getMobileMenuToggle().addEventListener('click', () => { UI.getSidebar().classList.toggle('active'); });
                document.querySelectorAll('.sidebar-menu .nav-item').forEach(item => {
                    item.addEventListener('click', (e) => { e.preventDefault(); UI.navigate(e.currentTarget.dataset.target); });
                });
                
                // Student List Interaction
                document.getElementById('student-list-container').addEventListener('click', handleStudentListClick);
                document.getElementById('student-search').addEventListener('input', Render.renderStudentList);
                document.getElementById('class-filter').addEventListener('change', Render.renderStudentList);
                document.getElementById('sort-filter').addEventListener('change', Render.renderStudentList);

                // Modals
                document.getElementById('close-profile-modal').addEventListener('click', UI.closeProfileModal);
                document.getElementById('close-edit-modal').addEventListener('click', UI.closeEditModal);
                document.getElementById('close-star-action-modal').addEventListener('click', UI.closeStarActionModal);

                // Forms
                document.getElementById('add-student-form').addEventListener('submit', handleAddStudent);
                document.getElementById('edit-student-form').addEventListener('submit', handleEditStudent);
                document.getElementById('star-action-form').addEventListener('submit', handleStarAction);
                
                // Profile Actions
                document.getElementById('edit-student-btn').addEventListener('click', () => UI.openEditModal(State.getCurrentStudentId()));
                document.getElementById('delete-student-btn').addEventListener('click', handleDeleteStudent);
                document.querySelectorAll('.profile-actions .star-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.action === 'add-star' ? 'add' : 'remove';
                        UI.openStarActionModal(type, State.getCurrentStudentId());
                    });
                });

                // Settings & Utility
                document.getElementById('dark-mode-toggle')?.addEventListener('click', () => {
                    State.appState.themeMode = State.appState.themeMode === 'dark' ? 'light' : 'dark';
                    State.saveState();
                    UI.updateThemeUI();
                    UI.showToast(`Switched to ${State.appState.themeMode.toUpperCase()} Mode.`, 'primary', State.appState.themeMode === 'dark' ? 'moon' : 'sun');
                });
                document.querySelectorAll('.theme-option').forEach(option => { 
                    option.addEventListener('click', (e) => {
                        State.appState.colorTheme = e.currentTarget.dataset.color;
                        State.saveState();
                        UI.updateThemeUI();
                        UI.showToast(`Theme color updated.`, 'primary', 'droplet');
                    }); 
                });
                
                // Placeholder handlers for PIN/Reset (Implement full logic if required later)
                document.getElementById('change-password-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newPin = document.getElementById('new-password').value;
                    if (newPin.length < 4 || !/^\d+$/.test(newPin)) {
                        UI.showToast("PIN must be 4 or more digits.", 'danger', 'alert-triangle');
                        return;
                    }
                    State.appState.teacherPassword = newPin;
                    State.saveState();
                    UI.showToast("Teacher PIN updated.", 'success', 'lock');
                });
                document.getElementById('remove-password-btn').addEventListener('click', () => {
                    State.appState.teacherPassword = null;
                    State.saveState();
                    UI.showToast("PIN security removed.", 'danger', 'unlock');
                });
                document.getElementById('full-reset-btn').addEventListener('click', () => {
                     if (confirm("WARNING: Are you absolutely sure you want to perform a FULL DATA RESET? This will delete ALL students and history.")) {
                        localStorage.clear();
                        window.location.reload(); 
                     }
                });

            }

            return { attachListeners };

        })(StateModule, UIModule, RenderModule, BadgeModule);


        // --- 6. App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            StateModule.loadState();
            BadgeModule.checkAllStudentsForBadges(); 
            HandlersModule.attachListeners();
            UIModule.updateThemeUI();

            UIModule.navigate('dashboard-view');
            RenderModule.renderAll(); 
            feather.replace();
        });
    </script>
</body>
</html>
