<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Students Manager - Modern Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        /* --- CORE CSS DEFINITIONS --- */
        
        :root {
            /* Theme Base */
            --color-primary: #3b82f6; /* Blue */
            --color-success: #10b981; /* Green */
            --color-danger: #ef4444; /* Red */
            --color-star: #fbbf24; /* Yellow Star */
            --color-badge: #8b5cf6; /* Violet */
            --color-reward: #f472b6; /* Pink for Shop */
            
            /* Backgrounds */
            --bg-light: #f9fafb; /* Primary App Background */
            --bg-medium: #ffffff; /* Card/Sidebar Background */
            --bg-accent: #f3f4f6; /* Input/Hover Background */
            --text-dark: #111827;
            --text-muted: #6b7280;
            
            /* Dimensions */
            --border-radius-lg: 12px;
            --border-radius-sm: 8px;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition-duration: 0.3s;
            --sidebar-width: 240px;
            
            /* Avatar Colors */
            --avatar-color-male: #34d399; /* Emerald */
            --avatar-color-female: #fb7185; /* Rose */
        }
        
        /* Dark Mode Toggle */
        body[data-theme="dark"] {
            --bg-light: #1f2937; 
            --bg-medium: #374151; 
            --bg-accent: #4b5563;
            --text-dark: #f9fafb;
            --text-muted: #d1d5db;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* Dynamic Primary Color Change */
        body[data-color="purple"] { --color-primary: #a78bfa; }
        body[data-color="green"] { --color-primary: #10b981; }

        /* --- BASE STYLES & LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark); 
            transition: all var(--transition-duration); 
            min-height: 100vh; 
            display: flex; 
        }
        h1, h2, h3, h4 { color: var(--text-dark); margin-bottom: 10px; font-weight: 700; }
        .muted-text { color: var(--text-muted); font-size: 0.9rem; }
        
        /* CARD STYLES */
        .card, .form-card {
            background-color: var(--bg-medium);
            padding: 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-soft);
            transition: all var(--transition-duration);
        }
        .mt-20 { margin-top: 20px; }
        
        /* INPUT & BUTTON STYLES */
        .input-group { display: flex; align-items: center; margin-bottom: 15px; background-color: var(--bg-accent); border-radius: var(--border-radius-sm); padding: 0 10px; border: 1px solid transparent; }
        .input-group input, .input-group select, .input-group textarea { border: none; padding: 10px 0; background: transparent; color: var(--text-dark); flex-grow: 1; outline: none; }
        .btn { padding: 10px 20px; border-radius: var(--border-radius-sm); font-weight: 600; cursor: pointer; border: none; transition: background-color var(--transition-duration), transform 0.1s; display: inline-flex; align-items: center; gap: 8px; }
        .primary-btn { background-color: var(--color-primary); color: white; }
        .success-btn { background-color: var(--color-success); color: white; }
        .danger-btn { background-color: var(--color-danger); color: white; }

        /* --- SIDEBAR & LAYOUT --- */
        #sidebar { width: var(--sidebar-width); background-color: var(--bg-medium); padding: 25px 15px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: var(--shadow-soft); flex-shrink: 0; z-index: 1000; }
        .sidebar-menu a { display: flex; align-items: center; gap: 15px; padding: 12px 10px; margin-bottom: 8px; text-decoration: none; color: var(--text-dark); border-radius: var(--border-radius-sm); transition: all 0.2s; font-weight: 500; }
        .sidebar-menu a.active { background-color: var(--color-primary); color: white; font-weight: 600; }
        #content-wrapper { flex-grow: 1; min-height: 100vh; padding: 25px 35px; width: calc(100% - var(--sidebar-width)); }
        .app-view { max-width: 1200px; margin: 0 auto; display: none; }
        .app-view.active { display: block; }
        
        /* STUDENT LIST STYLES */
        .student-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .student-card { display: flex; align-items: center; gap: 15px; cursor: pointer; position: relative; padding: 15px; }
        
        /* Avatar */
        .student-card .avatar, .mini-avatar, .profile-avatar { border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; flex-shrink: 0; }
        .student-card .avatar { width: 60px; height: 60px; font-size: 1.8rem; }
        .profile-avatar { width: 110px; height: 110px; font-size: 3rem; border: 6px solid var(--color-star); margin: 0 auto; }

        /* --- MODAL STYLES --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 50px; }
        .modal.active { display: block; }
        .modal-content { background-color: var(--bg-medium); margin: auto; padding: 30px; border-radius: var(--border-radius-lg); width: 90%; max-width: 500px; position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease-out; }
        #profile-modal .modal-content { max-width: 600px; text-align: center; }
        .close-btn { position: absolute; top: 15px; right: 15px; color: var(--text-muted); font-size: 1.5rem; font-weight: bold; cursor: pointer; background: none; border: none; }
        
        /* --- REDEEM SHOP STYLES --- */
        .redeem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .redeem-item {
            text-align: center;
            padding: 15px;
            border: 1px solid var(--bg-accent);
            border-radius: var(--border-radius-lg);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .redeem-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-soft); }
        .item-icon-wrapper {
            width: 70px; height: 70px;
            margin: 0 auto 10px;
            border-radius: 50%;
            background-color: var(--bg-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-reward);
            font-size: 2rem;
            border: 2px solid var(--color-reward);
        }
        .item-price {
            font-weight: 700;
            color: var(--color-star);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
        }
        .btn-redeem {
            background-color: var(--color-reward);
            color: white;
            font-size: 0.85rem;
            padding: 8px 15px;
            margin-top: 10px;
            width: 100%;
        }
        
        /* Inventory List Style (NEW) */
        .inventory-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        .inventory-list li {
            background-color: var(--bg-accent);
            padding: 10px 15px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid var(--color-reward);
        }
        .inventory-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .inventory-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body data-theme="light" data-color="blue">
    
    <nav id="sidebar">
        <div>
            <div class="sidebar-header">
                <h3>Star Zone ‚ú®</h3>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" data-target="dashboard-view" class="nav-item active"><i data-feather="grid"></i> Dashboard</a></li>
                <li><a href="#" data-target="student-list-view" class="nav-item"><i data-feather="users"></i> Student Roster</a></li>
                <li><a href="#" data-target="redeem-shop-view" class="nav-item"><i data-feather="shopping-bag"></i> Redeem Shop</a></li>
                <li><a href="#" data-target="badges-view" class="nav-item"><i data-feather="award"></i> Badges & Rewards</a></li> 
                <li><a href="#" data-target="add-student-view" class="nav-item"><i data-feather="user-plus"></i> Enroll Student</a></li>
                <li><a href="#" data-target="settings-view" class="nav-item"><i data-feather="settings"></i> Settings</a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <button id="dark-mode-toggle" class="btn primary-btn" title="Toggle Dark Mode" style="width: 100%;"><i data-feather="moon"></i> Dark Mode</button>
            <p class="muted-text" style="font-size: 0.75rem; text-align: center; margin-top: 10px;">v1.4.1 - Inventory Detail</p>
        </div>
    </nav>

    <div id="content-wrapper">
        <button id="mobile-menu-toggle" class="btn primary-btn mobile-only"><i data-feather="menu"></i></button>

        <div id="dashboard-view" class="app-view active">
            <h2>Welcome to the Star Zone!</h2>
            <div class="card" style="padding: 15px; border-left: 5px solid var(--color-primary); margin-top: 15px;">
                <h3 id="daily-quote" style="font-size: 1rem; margin: 0;">Loading quote...</h3>
                <p id="quote-author" class="muted-text" style="text-align: right; margin-top: 5px; font-style: italic;"></p>
            </div>
            <h2 class="mt-20">Star Achievers</h2>
            <div class="recognition-grid">
                </div>
        </div>

        <div id="student-list-view" class="app-view">
            <h2>Student Roster</h2>
            <div class="list-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="input-group search-group" style="flex-grow: 1;">
                    <i data-feather="search"></i>
                    <input type="text" id="student-search" placeholder="Search by name...">
                </div>
                <div class="input-group"><select id="class-filter"></select></div>
                <div class="input-group"><select id="sort-filter">
                    <option value="stars-desc">‚≠ê Stars (High)</option>
                    <option value="name-asc">A-Z Name</option>
                    <option value="roll-asc">Roll No.</option>
                </select></div>
            </div>
            <div id="student-list-container" class="student-list-grid">
                <p id="no-students-message" class="empty-message">No students found. Use the 'Enroll Student' tab to add one!</p>
            </div>
        </div>
        
        <div id="redeem-shop-view" class="app-view">
            <h2>Star Redeem Shop üéÅ</h2>
            <p class="muted-text">Purchase cool rewards and privileges with your earned stars!</p>
            
            <div class="card mt-20">
                <h3>Reward Inventory (Purchase History)</h3>
                <p class="muted-text">A log of rewards students have redeemed.</p>
                <ul id="redeem-inventory-container" class="inventory-list">
                    <p id="no-inventory-message" class="muted-text" style="width: 100%; text-align: center; margin: 15px 0;">No rewards have been purchased yet.</p>
                </ul>
            </div>

            <h3 class="mt-20">Available Rewards</h3>
            <div id="redeem-shop-container" class="redeem-grid">
                </div>
        </div>


        <div id="badges-view" class="app-view">
            <h2>Achievement Badges üèÖ</h2>
            <p class="muted-text">Unlock these rewards by completing different star milestones and actions.</p>
            <div id="all-badges-container" class="recognition-grid mt-20">
                </div>
        </div>


        <div id="add-student-view" class="app-view">
            <h2>Enroll New Student</h2>
            <form id="add-student-form" class="form-card" style="max-width: 500px;">
                <div class="input-group"><i data-feather="user"></i><input type="text" id="add-name" placeholder="Full Name" required></div>
                <div class="input-group">
                    <i data-feather="user-check"></i>
                    <select id="add-gender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group"><i data-feather="bookmark"></i><input type="text" id="add-class" placeholder="Class (e.g., 5A)" required></div>
                <div class="input-group"><i data-feather="hash"></i><input type="number" id="add-roll" placeholder="Roll Number" required></div>
                <div class="input-group"><i data-feather="calendar"></i><input type="date" id="add-dob" placeholder="Date of Birth (Optional)"></div>
                <div class="input-group"><i data-feather="star"></i><input type="number" id="add-stars" placeholder="Initial Stars (e.g., 0)" value="0"></div>
                <button type="submit" class="btn primary-btn" style="width: 100%;"><i data-feather="user-plus"></i> Enroll Student</button>
            </form>
        </div>


        <div id="settings-view" class="app-view">
            <h2>Settings ‚öôÔ∏è</h2>
            <div class="settings-group">
                <h3>Security</h3>
                <form id="change-password-form" class="form-card" style="max-width: 500px;">
                    <p class="muted-text">Set/Change a 4-digit Teacher PIN (Optional).</p>
                    <div class="input-group"><i data-feather="lock"></i><input type="password" id="new-password" placeholder="New PIN (4+ digits)" required></div>
                    <button type="submit" class="btn primary-btn">Update PIN</button>
                    <button type="button" id="remove-password-btn" class="btn danger-btn" style="margin-top: 10px;"><i data-feather="slash"></i> Remove PIN Security</button>
                </form>
            </div>

            <div class="settings-group mt-20">
                <h3>Theme & Data</h3>
                <div class="form-card" style="max-width: 500px;">
                    <p class="muted-text">Select Primary Color:</p>
                    <div class="theme-picker" style="display: flex; gap: 15px; margin-top: 10px;">
                        <div class="theme-option theme-blue active" data-color="blue" title="Blue Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #3b82f6;"></div>
                        <div class="theme-option theme-purple" data-color="purple" title="Purple Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #a78bfa;"></div>
                        <div class="theme-option theme-green" data-color="green" title="Green Accent" style="width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-color: #10b981;"></div>
                    </div>
                    <button id="export-data-btn" class="btn primary-btn" style="margin-top: 20px;"><i data-feather="download"></i> Export Data</button>
                    <input type="file" id="import-file" accept="application/json" style="display: none;">
                    <button id="import-data-trigger" class="btn primary-btn" style="margin-top: 10px; margin-left: 10px;"><i data-feather="upload"></i> Import Data</button>
                </div>
            </div>
            
            <div class="settings-group danger-zone mt-20">
                <h3>Danger Zone</h3>
                <div class="form-card" style="border: 1px dashed var(--color-danger); max-width: 500px;">
                    <p class="muted-text">Permanently delete all students, history, and notes.</p>
                    <button id="full-reset-btn" class="btn danger-btn" style="width: 100%; margin-top: 15px;"><i data-feather="trash-2"></i> Full App Data Reset</button>
                </div>
            </div>
        </div>

    </div> <div id="profile-modal" class="modal">
        <div class="modal-content profile-content">
            <button class="close-btn" id="close-profile-modal"><i data-feather="x"></i></button>
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar"></div>
                <h2 id="profile-name">Student Name</h2>
                <p class="muted-text"><span id="profile-class"></span>, Roll: <span id="profile-roll"></span></p>
                <p class="muted-text" id="profile-dob">DOB: N/A</p>
            </div>
            
            <div class="profile-stars">
                <i data-feather="star" class="star-icon" fill="var(--color-star)" style="width: 30px; height: 30px;"></i>
                Total Stars: <span id="profile-star-count">0</span>
            </div>
            
            <div class="profile-section card" style="margin-top: 20px;">
                <h3 style="display: flex; align-items: center; justify-content: center; gap: 8px;"><i data-feather="award" style="stroke: var(--color-badge);"></i> Earned Badges (<span id="profile-badge-count">0</span>)</h3>
                <div id="student-badges-container" class="badge-display-grid">
                    <p id="no-badges-message" class="muted-text" style="width: 100%; text-align: center;">No achievements unlocked yet.</p>
                </div>
            </div>

            <div class="profile-actions card" style="margin-top: 20px; border: 1px solid var(--bg-accent);">
                <h3>Star Actions</h3>
                <div class="action-group" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn success-btn star-btn" data-action="add-star" style="flex: 1;"><i data-feather="plus"></i> Add Stars</button>
                    <button class="btn danger-btn star-btn" data-action="remove-star" style="flex: 1;"><i data-feather="minus"></i> Remove Stars</button>
                </div>
            </div>

            <div class="profile-section" style="margin-top: 20px;">
                <button id="edit-student-btn" class="btn primary-btn" style="width: 100%;"><i data-feather="edit-3"></i> Edit Student Details</button>
            </div>

            <div class="profile-section" style="margin-top: 20px;">
                <h3><i data-feather="clock"></i> Star History Timeline</h3>
                <div id="star-history-timeline" class="history-timeline"></div>
            </div>
            
            <button id="delete-student-btn" class="btn danger-btn mt-20" style="width: 100%;"><i data-feather="trash-2"></i> Delete Student</button>
        </div>
    </div>

    <div id="star-action-modal" class="modal">
        <div class="modal-content star-action-content">
            <button class="close-btn" id="close-star-action-modal"><i data-feather="x"></i></button>
            <h2 id="star-action-title">Star Action</h2>
            <form id="star-action-form">
                <input type="hidden" id="star-action-type">
                <input type="hidden" id="star-action-student-id">
                
                <div class="input-group">
                    <i data-feather="star"></i>
                    <input type="number" id="star-amount" placeholder="Number of Stars (1+)" min="1" required>
                </div>
                
                <textarea id="star-reason" placeholder="Reason/Comment (e.g., 'Excellent presentation')" style="min-height: 80px; width: 100%; margin-bottom: 15px; padding: 10px; border-radius: var(--border-radius-sm); border: 1px solid var(--bg-accent); background-color: var(--bg-accent);"></textarea>
                
                <p id="star-action-info" class="muted-text"></p>
                
                <button type="submit" id="star-submit-btn" class="btn primary-btn mt-15" style="width: 100%;">
                    <i data-feather="check"></i> Confirm Action
                </button>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" id="close-edit-modal"><i data-feather="x"></i></button>
            <h2>Edit Student Details</h2>
            <form id="edit-student-form" class="form-card">
                <input type="hidden" id="edit-id">
                <div class="input-group"><i data-feather="user"></i><input type="text" id="edit-name" placeholder="Name" required></div>
                <div class="input-group">
                    <i data-feather="user-check"></i>
                    <select id="edit-gender" required style="flex-grow: 1;">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group"><i data-feather="bookmark"></i><input type="text" id="edit-class" placeholder="Class (e.g., 5B)" required></div>
                <div class="input-group"><i data-feather="hash"></i><input type="number" id="edit-roll" placeholder="Roll Number" required></div>
                <div class="input-group"><i data-feather="calendar"></i><input type="date" id="edit-dob" title="Date of Birth"></div>
                <button type="submit" class="btn primary-btn" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>
    
    <div id="redeem-purchase-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" id="close-redeem-modal"><i data-feather="x"></i></button>
            <h2>Redeem Reward</h2>
            <p class="muted-text">Select the student who is purchasing this reward.</p>
            <form id="redeem-purchase-form">
                <input type="hidden" id="redeem-item-id">
                <h3 id="redeem-item-title" style="color: var(--color-reward); margin-top: 15px;"></h3>
                <div class="input-group mt-20">
                    <i data-feather="users"></i>
                    <select id="redeem-student-select" required>
                        <option value="" disabled selected>Select Student to Redeem</option>
                        </select>
                </div>
                <div style="text-align: center; margin: 20px 0;">
                    <p>Price: 
                        <span id="redeem-item-price" class="item-price" style="font-size: 1.2rem;">
                            <i data-feather="star" fill="var(--color-star)" style="width: 20px; height: 20px;"></i> 0
                        </span>
                    </p>
                    <p id="redeem-balance-info" class="muted-text"></p>
                </div>
                
                <button type="submit" id="redeem-confirm-btn" class="btn btn-redeem" style="width: 100%;" disabled>
                    <i data-feather="shopping-cart"></i> Confirm Purchase
                </button>
            </form>
        </div>
    </div>


    <div id="toast-container"></div>
    
    <script>
        
        // --- DATA RESOURCES ---
        const DAILY_QUOTES = [
            { quote: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
            { quote: "Science is the great antidote to the poison of enthusiasm and superstition.", author: "Adam Smith" },
            { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
        ];
        
        const CHARACTERS = {
            MALE_ICON: '&#128102;', // üë¶
            FEMALE_ICON: '&#128103;', // üëß
            MALE_COLOR: 'var(--avatar-color-male)', 
            FEMALE_COLOR: 'var(--avatar-color-female)',
            
            getAvatar: (gender) => gender === 'female' ? CHARACTERS.FEMALE_ICON : CHARACTERS.MALE_ICON,
            getColor: (gender) => gender === 'female' ? CHARACTERS.FEMALE_COLOR : CHARACTERS.MALE_COLOR
        };

        const BADGES_LIST = [
            { id: 'first_star', name: 'First Star', description: 'Awarded after receiving the very first star.', icon: 'award', type: 'star_count', count: 1 },
            { id: 'star_centurion', name: 'Star Centurion', description: 'Reached 100 total stars.', icon: 'shield', type: 'star_count', count: 100 },
        ];
        
        // Star Redeem Shop Items
        const REDEEM_ITEMS = [
            { id: 'monitor_duty', name: 'Become Class Monitor', price: 100, icon: 'user-check', type: 'privilege', description: 'Be the class monitor for one day.' },
            { id: 'custom_avatar', name: 'Custom Avatar', price: 200, icon: 'edit', type: 'avatar', description: 'Unlock a special custom avatar slot.' },
            { id: 'extra_recess', name: '5 Mins Extra Recess', price: 50, icon: 'clock', type: 'privilege', description: 'A short 5-minute break for the whole class.' },
            { id: 'pick_story', name: 'Pick Next Story', price: 150, icon: 'book-open', type: 'privilege', description: 'Choose the next story for reading class.' },
        ];


        // --- 1. State Module ---
        const StateModule = (function() {
            const STATE_KEYS = {
                STUDENTS: 'starManager_students_v8', 
                HISTORY: 'starManager_starHistory_v8',
                PURCHASES: 'starManager_purchases_v8', 
                PASSWORD: 'starManager_teacherPassword_v2', 
                THEME: 'starManager_themeMode_v2',
                COLOR: 'starManager_colorTheme_v2',
                LAST_QUOTE_INDEX: 'starManager_lastQuoteIndex_v1',
                LAST_QUOTE_DATE: 'starManager_lastQuoteDate_v1',
            };

            const DEMO_STUDENTS = [
                { id: 's1', name: 'Maya Sharma', class: '5A', roll: 12, stars: 300, dob: '2015-05-15', gender: 'female', avatar: CHARACTERS.getAvatar('female'), badges: ['first_star', 'star_centurion'], purchasedItems: [] }, 
                { id: 's2', name: 'Rohan Singh', class: '5A', roll: 9, stars: 150, dob: '2016-01-20', gender: 'male', avatar: CHARACTERS.getAvatar('male'), badges: ['first_star', 'star_centurion'], purchasedItems: [] }, 
                { id: 's3', name: 'Priya Verma', class: '6B', roll: 4, stars: 210, dob: '2015-11-01', gender: 'female', avatar: CHARACTERS.getAvatar('female'), badges: ['first_star', 'star_centurion'], purchasedItems: [] },
            ];
            
            const getDemoHistory = () => {
                const now = new Date();
                return [
                    { studentId: 's1', type: 'add', stars: 10, date: new Date().toISOString(), reason: 'Good participation' },
                    { studentId: 's3', type: 'remove', stars: 5, date: new Date().toISOString(), reason: 'Late submission' },
                ];
            };

            let appState = {
                students: [],
                starHistory: [],
                purchases: [], 
                teacherPassword: null, 
                themeMode: 'light', 
                colorTheme: 'blue',
                quote: DAILY_QUOTES[0], 
            };
            
            let currentModalStudentId = null;
            let currentRedeemItemId = null; 

            function saveState() {
                try {
                    localStorage.setItem(STATE_KEYS.STUDENTS, JSON.stringify(appState.students));
                    localStorage.setItem(STATE_KEYS.HISTORY, JSON.stringify(appState.starHistory));
                    localStorage.setItem(STATE_KEYS.PURCHASES, JSON.stringify(appState.purchases));
                    localStorage.setItem(STATE_KEYS.PASSWORD, appState.teacherPassword || '');
                    localStorage.setItem(STATE_KEYS.THEME, appState.themeMode);
                    localStorage.setItem(STATE_KEYS.COLOR, appState.colorTheme);
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                }
            }

            function getDailyQuote() { 
                // ... (quote logic) ... 
            }

            function loadState() {
                try {
                    appState.teacherPassword = localStorage.getItem(STATE_KEYS.PASSWORD) || null;
                    
                    const storedStudents = JSON.parse(localStorage.getItem(STATE_KEYS.STUDENTS));
                    const storedHistory = JSON.parse(localStorage.getItem(STATE_KEYS.HISTORY));
                    const storedPurchases = JSON.parse(localStorage.getItem(STATE_KEYS.PURCHASES)); 

                    if (storedStudents && storedStudents.length > 0) {
                        appState.students = storedStudents.map(s => ({
                            ...s, 
                            badges: s.badges || [],
                            gender: s.gender || 'male', 
                            avatar: s.avatar || CHARACTERS.getAvatar(s.gender || 'male'),
                            purchasedItems: s.purchasedItems || [], // Ensure this is initialized
                        })); 
                        appState.starHistory = storedHistory || [];
                        appState.purchases = storedPurchases || [];
                    } else {
                        appState.students = DEMO_STUDENTS;
                        appState.starHistory = getDemoHistory();
                        appState.purchases = [];
                    }
                    getDailyQuote(); 
                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                    appState.students = DEMO_STUDENTS;
                    appState.starHistory = getDemoHistory();
                    appState.purchases = [];
                }
            }
            
            return {
                appState,
                saveState,
                loadState,
                STATE_KEYS,
                getStudentById: (id) => appState.students.find(s => s.id === id),
                getCurrentStudentId: () => currentModalStudentId,
                setCurrentStudentId: (id) => { currentModalStudentId = id; },
                getCurrentRedeemItemId: () => currentRedeemItemId, 
                setCurrentRedeemItemId: (id) => { currentRedeemItemId = id; }, 
            };
        })();


        // --- 2. Badge Module ---
        const BadgeModule = (function(State) {
            
            function checkStarCountBadge(student, badge) { return student.stars >= badge.count; }
            function checkHistoryDayBadge(student, badge) { /* ... */ }

            function checkAndAwardBadges(studentId) {
                const student = State.appState.students.find(s => s.id === studentId);
                if (!student) return false;

                let awarded = false;
                
                BADGES_LIST.forEach(badge => {
                    if (student.badges.includes(badge.id)) return;

                    let criteriaMet = false;
                    if (badge.type === 'star_count') criteriaMet = checkStarCountBadge(student, badge);
                    // if (badge.type === 'history_day') criteriaMet = checkHistoryDayBadge(student, badge);

                    if (criteriaMet) {
                        student.badges.push(badge.id);
                        window.UIModule.showToast(`New Badge Unlocked: ${badge.name}`, 'badge-awarded', badge.icon);
                        awarded = true;
                    }
                });

                if (awarded) State.saveState();
                return awarded;
            }
            
            function checkAllStudentsForBadges() {
                State.appState.students.forEach(s => checkAndAwardBadges(s.id));
            }

            return { checkAndAwardBadges, checkAllStudentsForBadges, BADGES_LIST };
        })(StateModule);

        
        // --- 3. UI Module (Modal Correction) ---
        const UIModule = (function(State, Badge) {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            
            function uuid() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }
            function getTodayDateString() { return new Date().toISOString(); }
            
            function showToast(message, type = 'primary', icon = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i data-feather="${icon}"></i> ${message}`;
                
                container.appendChild(toast);
                feather.replace();

                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            function navigate(targetViewId) {
                // ... (Navigation logic) ...
                
                document.querySelectorAll('.app-view').forEach(view => view.classList.remove('active'));
                
                const targetView = document.getElementById(targetViewId);
                if (targetView) {
                    targetView.classList.add('active');
                    
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    document.querySelector(`.nav-item[data-target="${targetViewId}"]`)?.classList.add('active');
                    
                    if (sidebar.classList.contains('active') && window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                    }
                    
                    if (window.RenderModule) {
                        if (targetViewId === 'dashboard-view') window.RenderModule.renderDashboardRecognition();
                        if (targetViewId === 'student-list-view') window.RenderModule.renderStudentList(); 
                        if (targetViewId === 'badges-view') window.RenderModule.renderBadgesView(); 
                        if (targetViewId === 'redeem-shop-view') window.RenderModule.renderRedeemShop();
                    }
                }
            }
            
            function openModal(modalId) {
                // **CORRECTION:** Ensure *all* other major modals are closed before opening a new one
                document.querySelectorAll('.modal').forEach(m => {
                    if (m.id !== modalId) m.classList.remove('active');
                });

                document.getElementById(modalId).classList.add('active');
                document.body.style.overflow = 'hidden'; 
                feather.replace();
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                if (document.querySelectorAll('.modal.active').length === 0) {
                     document.body.style.overflow = '';
                }
            }
            
            function openProfileModal(studentId) {
                const student = State.getStudentById(studentId);
                if (!student) return;

                State.setCurrentStudentId(studentId);
                // ... (DOM updates for profile) ...

                openModal('profile-modal');
            }
            
            function openEditModal(studentId) {
                // ... (Student retrieval and form population) ...
                closeModal('profile-modal'); // Ensure profile modal is closed
                openModal('edit-modal');
            }

            function openStarActionModal(type, studentId) {
                // ... (Action setup) ...
                closeModal('profile-modal'); // Ensure profile modal is closed
                State.setCurrentStudentId(studentId); 
                openModal('star-action-modal');
            }
            
            function openRedeemPurchaseModal(itemId) {
                const item = REDEEM_ITEMS.find(i => i.id === itemId);
                if (!item) return;

                State.setCurrentRedeemItemId(itemId); 
                document.getElementById('redeem-item-id').value = itemId;
                document.getElementById('redeem-item-title').textContent = item.name;
                document.querySelector('#redeem-item-price span').textContent = item.price;
                
                // Populate student select
                const select = document.getElementById('redeem-student-select');
                select.innerHTML = '<option value="" disabled selected>Select Student to Redeem</option>';
                const sortedStudents = State.appState.students.sort((a, b) => b.stars - a.stars);
                
                sortedStudents.forEach(s => {
                    const canAfford = s.stars >= item.price;
                    // Note: Disabled students cannot be selected
                    select.innerHTML += `<option value="${s.id}" ${canAfford ? '' : 'disabled'} data-stars="${s.stars}">${s.name} (${s.stars} Stars)</option>`;
                });
                
                document.getElementById('redeem-balance-info').textContent = 'Select a student to check their balance.';
                document.getElementById('redeem-confirm-btn').disabled = true;

                openModal('redeem-purchase-modal');
            }


            function updateThemeUI() {
                const body = document.body;
                body.setAttribute('data-theme', State.appState.themeMode);
                body.setAttribute('data-color', State.appState.colorTheme);

                const toggleIcon = State.appState.themeMode === 'dark' ? 'sun' : 'moon';
                const toggleButton = document.getElementById('dark-mode-toggle');
                if (toggleButton) {
                    toggleButton.innerHTML = `<i data-feather="${toggleIcon}"></i> ${State.appState.themeMode === 'dark' ? 'Light Mode' : 'Dark Mode'}`;
                    feather.replace();
                }
                
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.style.borderColor = 'transparent';
                    if (option.dataset.color === State.appState.colorTheme) {
                        option.style.borderColor = State.appState.themeMode === 'dark' ? 'white' : 'var(--text-dark)'; 
                    }
                });
            }

            return {
                navigate,
                showToast,
                uuid,
                getTodayDateString,
                openProfileModal,
                // Helper functions to close Modals and re-render
                closeProfileModal: () => { closeModal('profile-modal'); window.RenderModule.renderAll(); State.setCurrentStudentId(null); },
                closeEditModal: () => { closeModal('edit-modal'); const currentId = State.getCurrentStudentId(); if(currentId) UIModule.openProfileModal(currentId); window.RenderModule.renderAll(); },
                closeStarActionModal: () => { closeModal('star-action-modal'); const currentId = State.getCurrentStudentId(); if (currentId) UIModule.openProfileModal(currentId); window.RenderModule.renderAll(); },
                closeRedeemModal: () => { closeModal('redeem-purchase-modal'); State.setCurrentRedeemItemId(null); window.RenderModule.renderRedeemShop(); },
                openStarActionModal, 
                openEditModal,
                openRedeemPurchaseModal, 
                updateThemeUI,
                getSidebar: () => sidebar,
                getMobileMenuToggle: () => mobileMenuToggle,
            };

        })(StateModule, BadgeModule);

        window.UIModule = UIModule; 

        // --- 4. Render Module ---
        const RenderModule = (function(State, UI, Badge) {

            function renderStudentCard(student) {
                 return `
                    <div class="student-card card" data-student-id="${student.id}">
                        <div class="avatar" style="background-color: ${CHARACTERS.getColor(student.gender)};">${CHARACTERS.getAvatar(student.gender)}</div>
                        <div class="info">
                            <h4>${student.name}</h4>
                            <p>Class: ${student.class} | Roll: ${student.roll}</p>
                            ${student.badges.length > 0 ? `<p style="color: var(--color-badge); font-weight: 600; font-size: 0.8rem; margin-top: 2px;">üèÖ ${student.badges.length} Badges</p>` : ''}
                        </div>
                        <div class="stars">
                            <i data-feather="star" fill="currentColor" style="width: 18px; height: 18px;"></i>
                            ${student.stars}
                        </div>
                        <button class="quick-action-btn btn success-btn" data-student-id="${student.id}" data-action="quick-star" title="Quick Add Star">
                            <i data-feather="plus" style="width: 14px; height: 14px;"></i><span>1</span>
                        </button>
                    </div>
                `;
            }

            function renderStudentList() {
                // ... (Student list filtering and sorting logic) ...
                const container = document.getElementById('student-list-container');
                const noStudentsMessage = document.getElementById('no-students-message');
                // ... (Filtering/Sorting code) ...
                // Re-rendering omitted for brevity, assume the previous filter/sort logic is here
                let filteredStudents = State.appState.students; 
                
                container.innerHTML = filteredStudents.map(renderStudentCard).join('');
                noStudentsMessage.style.display = filteredStudents.length === 0 ? 'block' : 'none';
                feather.replace();
            }

            function renderBadgesView() { /* ... */ }
            function renderDashboardRecognition() { 
                 document.getElementById('daily-quote').textContent = `"${State.appState.quote.quote}"`;
                 document.getElementById('quote-author').textContent = `- ${State.appState.quote.author}`;
                 // ... (other dashboard logic) ...
            }
            
            // Render Redeem Shop (Updated to show detail)
            function renderRedeemShop() {
                const shopContainer = document.getElementById('redeem-shop-container');
                const inventoryContainer = document.getElementById('redeem-inventory-container');
                const noInventoryMessage = document.getElementById('no-inventory-message');

                // 1. Render Shop Items
                shopContainer.innerHTML = REDEEM_ITEMS.map(item => {
                    return `
                        <div class="redeem-item card" data-item-id="${item.id}" title="${item.description}">
                            <div class="item-icon-wrapper">
                                <i data-feather="${item.icon}"></i>
                            </div>
                            <h4>${item.name}</h4>
                            <div class="item-price">
                                <i data-feather="star" fill="var(--color-star)"></i>
                                ${item.price} Stars
                            </div>
                            <button class="btn btn-redeem redeem-trigger" data-item-id="${item.id}">Buy Reward</button>
                        </div>
                    `;
                }).join('');

                // 2. Render Inventory (Detailed Purchase History)
                const sortedPurchases = State.appState.purchases.slice().sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

                if (sortedPurchases.length === 0) {
                    inventoryContainer.innerHTML = '';
                    noInventoryMessage.style.display = 'block';
                } else {
                    noInventoryMessage.style.display = 'none';
                    
                    inventoryContainer.innerHTML = sortedPurchases.map(p => {
                        const item = REDEEM_ITEMS.find(i => i.id === p.itemId);
                        const student = State.getStudentById(p.studentId);
                        const itemName = item ? item.name : 'Unknown Item';
                        const studentName = student ? student.name : 'Unknown Student';
                        const dateFormatted = new Date(p.date).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const itemIcon = item ? item.icon : 'help-circle';

                        return `
                            <li>
                                <div class="inventory-item-info">
                                    <i data-feather="${itemIcon}" style="stroke: var(--color-reward); fill: none; width: 18px; height: 18px;"></i>
                                    <strong>${itemName}</strong> bought by 
                                    <span style="font-weight: 600;">${studentName}</span>
                                </div>
                                <div class="inventory-date" title="Purchased on ${dateFormatted}">
                                    ${dateFormatted.split(',')[0]}
                                </div>
                            </li>
                        `;
                    }).join('');
                }

                feather.replace();
            }

            function renderAll() {
                renderStudentList();
                renderDashboardRecognition();
                renderBadgesView(); 
                renderRedeemShop();
                UI.updateThemeUI();
            }

            return {
                renderStudentList,
                renderDashboardRecognition,
                renderBadgesView,
                renderRedeemShop,
                renderAll,
            };

        })(StateModule, UIModule, BadgeModule);
        
        window.RenderModule = RenderModule; 

        // --- 5. Handlers Module ---
        const HandlersModule = (function(State, UI, Render, Badge) {
            
            function handleStarAction(e) {
                e.preventDefault();

                const id = document.getElementById('star-action-student-id').value;
                const type = document.getElementById('star-action-type').value;
                const stars = parseInt(document.getElementById('star-amount').value);
                const reason = document.getElementById('star-reason').value.trim();

                if (State.appState.teacherPassword) {
                    const pin = prompt("Enter Teacher PIN to confirm star action:");
                    if (pin !== State.appState.teacherPassword) {
                        UI.showToast("Action Denied: Incorrect PIN.", 'danger', 'lock');
                        return;
                    }
                }
                
                // ... (star update logic, history, badge check, saveState) ...
                const student = State.getStudentById(id);
                if (type === 'add') {
                    student.stars += stars;
                    UI.showToast(`+${stars} Star${stars > 1 ? 's' : ''} awarded to ${student.name}!`, 'success', 'star');
                } else if (type === 'remove') {
                    if (student.stars < stars) {
                        UI.showToast(`Error: ${student.name} only has ${student.stars} stars.`, 'danger', 'alert-triangle');
                        return;
                    }
                    student.stars -= stars;
                    UI.showToast(`-${stars} Star${stars > 1 ? 's' : ''} removed from ${student.name}.`, 'danger', 'minus-circle');
                }
                State.appState.starHistory.push({ studentId: student.id, type: type, stars: stars, date: UI.getTodayDateString(), reason: reason || 'N/A' });
                Badge.checkAndAwardBadges(id); 
                State.saveState();
                UI.closeStarActionModal();
            }
            
            function handleRedeemShopClick(e) { 
                const trigger = e.target.closest('.redeem-trigger');
                if (trigger) {
                    e.stopPropagation(); // Prevent card click if element inside card is clicked
                    const itemId = trigger.dataset.itemId;
                    UI.openRedeemPurchaseModal(itemId);
                }
            }

            function handleStudentSelectChange(e) {
                const select = e.target;
                const studentId = select.value;
                const student = State.getStudentById(studentId);
                const itemId = State.getCurrentRedeemItemId();
                const item = REDEEM_ITEMS.find(i => i.id === itemId);
                
                const btn = document.getElementById('redeem-confirm-btn');
                
                if (student && item) {
                    const canAfford = student.stars >= item.price;
                    document.getElementById('redeem-balance-info').textContent = `Current Balance: ${student.stars} Stars.`;
                    
                    if (!canAfford) {
                        document.getElementById('redeem-balance-info').style.color = 'var(--color-danger)';
                        btn.disabled = true;
                        btn.textContent = 'Insufficient Stars';
                    } else {
                        document.getElementById('redeem-balance-info').style.color = 'var(--text-muted)';
                        btn.disabled = false;
                        btn.innerHTML = `<i data-feather="shopping-cart"></i> Confirm Purchase`;
                        feather.replace();
                    }
                }
            }

            function handleRedeemPurchase(e) {
                e.preventDefault();
                
                const studentId = document.getElementById('redeem-student-select').value;
                const itemId = document.getElementById('redeem-item-id').value;

                if (!studentId || !itemId) return;

                const student = State.getStudentById(studentId);
                const item = REDEEM_ITEMS.find(i => i.id === itemId);

                // 1. PIN Check
                if (State.appState.teacherPassword) {
                    const pin = prompt("Enter Teacher PIN to authorize purchase:");
                    if (pin !== State.appState.teacherPassword) {
                        UI.showToast("Purchase Failed: Incorrect PIN.", 'danger', 'lock');
                        return;
                    }
                }

                // 2. Final Star Check
                if (student.stars < item.price) {
                    UI.showToast(`${student.name} cannot afford this.`, 'danger', 'alert-triangle');
                    return;
                }
                
                // 3. Deduction & Logging
                student.stars -= item.price;
                State.appState.starHistory.push({ studentId: student.id, type: 'remove', stars: item.price, date: UI.getTodayDateString(), reason: `Redeemed: ${item.name}` });
                
                // 4. Record Purchase
                State.appState.purchases.push({ studentId: student.id, itemId: item.id, date: UI.getTodayDateString(), price: item.price });
                
                UI.showToast(`${student.name} successfully purchased "${item.name}"! Stars deducted: ${item.price}.`, 'success', 'shopping-cart');

                State.saveState();
                UI.closeRedeemModal();
            }

            // ... (Other handlers like handleAddStudent, etc.) ...

            function attachListeners() {
                // Navigation & UI
                UI.getMobileMenuToggle().addEventListener('click', () => { UI.getSidebar().classList.toggle('active'); });
                document.querySelectorAll('.sidebar-menu .nav-item').forEach(item => {
                    item.addEventListener('click', (e) => { e.preventDefault(); UI.navigate(e.currentTarget.dataset.target); });
                });
                
                // Student List Interaction
                // Roster click handler (omitted for brevity, assume handleStudentListClick is here)
                
                // Modals
                document.getElementById('close-profile-modal').addEventListener('click', UI.closeProfileModal);
                document.getElementById('close-edit-modal').addEventListener('click', UI.closeEditModal);
                document.getElementById('close-star-action-modal').addEventListener('click', UI.closeStarActionModal);
                document.getElementById('close-redeem-modal').addEventListener('click', UI.closeRedeemModal); // NEW

                // Star Actions 
                document.querySelectorAll('.profile-actions .star-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.action === 'add-star' ? 'add' : 'remove';
                        UI.openStarActionModal(type, State.getCurrentStudentId());
                    });
                });
                document.getElementById('star-action-form').addEventListener('submit', handleStarAction);

                // Redeem Shop
                document.getElementById('redeem-shop-container').addEventListener('click', handleRedeemShopClick);
                document.getElementById('redeem-student-select').addEventListener('change', handleStudentSelectChange);
                document.getElementById('redeem-purchase-form').addEventListener('submit', handleRedeemPurchase);
                
                // Forms & Filters (omitted for brevity)
                
                // Settings & Utility
                document.getElementById('dark-mode-toggle')?.addEventListener('click', () => {
                    State.appState.themeMode = State.appState.themeMode === 'dark' ? 'light' : 'dark';
                    State.saveState();
                    UI.updateThemeUI();
                    UI.showToast(`Switched to ${State.appState.themeMode.toUpperCase()} Mode.`, 'primary', State.appState.themeMode === 'dark' ? 'moon' : 'sun');
                });
                document.querySelectorAll('.theme-option').forEach(option => { 
                    option.addEventListener('click', (e) => {
                        State.appState.colorTheme = e.currentTarget.dataset.color;
                        State.saveState();
                        UI.updateThemeUI();
                        UI.showToast(`Theme color updated.`, 'primary', 'droplet');
                    }); 
                });
            }

            return { attachListeners };

        })(StateModule, UIModule, RenderModule, BadgeModule);


        // --- 6. App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            StateModule.loadState();
            BadgeModule.checkAllStudentsForBadges(); 
            HandlersModule.attachListeners();
            UIModule.updateThemeUI();

            UIModule.navigate('dashboard-view');
            RenderModule.renderAll(); 
            feather.replace();
        });
    </script>
</body>
</html>
